import logging
import sqlite3
import os
import json
import csv
import io
import asyncio
import shutil
from datetime import datetime, timedelta
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, ConversationHandler, \
    CallbackQueryHandler

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ –¢–û–ö–ï–ù –ù–ê –í–ê–® –†–ï–ê–õ–¨–ù–´–ô –¢–û–ö–ï–ù –ë–û–¢–ê ‚ö†Ô∏è
BOT_TOKEN = os.getenv("BOT_TOKEN", "8460454617:AAHSl5BZueNVa-dOBXj8PlUFsn-9wfIVfe4")

# ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® USER_ID ‚ö†Ô∏è
ADMIN_IDS = [1292233190, 8025115013, 7691643567, 5383429536, 2141467987, 7805404869]

# ID —á–∞—Ç–∞ –¥–ª—è –ª–æ–≥–æ–≤ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π ID –≤–∞—à–µ–≥–æ —á–∞—Ç–∞)
LOG_CHAT_ID = -1003369623857  # ID —á–∞—Ç–∞ –∏–∑ —Å—Å—ã–ª–∫–∏ https://t.me/c/3369623857/5

# ID —Ç–µ–º—ã (—Ç–æ–ø–∏–∫–∞) –≤ —á–∞—Ç–µ –¥–ª—è –ª–æ–≥–æ–≤ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ–º—ã)
LOG_TOPIC_ID = 5  # ID —Ç–µ–º—ã –∏–∑ —Å—Å—ã–ª–∫–∏ (—Ü–∏—Ñ—Ä–∞ –ø–æ—Å–ª–µ /)

# –†–æ–ª–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø—É—Å—Ç–æ, –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É)
MODERATOR_IDS = []  # –°–ø–∏—Å–æ–∫ ID –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler
QUESTION, MODERATION, BROADCAST, USER_SEARCH, FEEDBACK, ADD_TO_BLACKLIST, REMOVE_FROM_BLACKLIST, BLACKLIST_SEARCH = range(
    8)

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —á–µ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤
BLACKLIST_CLAN = "–ß–°–ö"
BLACKLIST_STAFF = "–ß–°–ö–ö"

# –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
ADMIN_USERNAME_MAP = {
    1292233190: "@x3klls",
    8025115013: "@hiertoy",
    7691643567: "@anchous_faraon",
    5383429536: "@kanseysau",
    2141467987: "@Loveteaone",
    7805404869: "@hilliees",
    7915981250: "@mephistopxeles"
}

# –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ID –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø—É—Å—Ç–æ)
MODERATOR_USERNAME_MAP = {
    # –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /addmoderator
}

# –°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç –¥–ª—è –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞—è–≤–æ–∫
CHAT_LINK = "https://t.me/+fXw4XzUFj8RlNGQ6"

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞–Ω–µ dyO
CLAN_RULES = """
üìú –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞–Ω–µ dyO
–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è –≤ –∫–ª–∞–Ω–µ dyO, —Ö–æ—á—É —Å–∫–∞–∑–∞—Ç—å –ø–∞—Ä—É —Å–ª–æ–≤ –æ –∫–ª–∞–Ω–µ =)

–õ–∏–¥–µ—Ä –∫–ª–∞–Ω–∞ : daquachi4r @x3klls

–ì–ª–∞–≤–Ω—ã–π –∫—É—Ä–∞—Ç–æ—Ä : freg_grief854 @anchous_faraon
–ö—É—Ä–∞—Ç–æ—Ä : LY4HE_D0MA @Loveteaone
–ö—É—Ä–∞—Ç–æ—Ä : setore @hiertoy

–ö–ª–∞–Ω –∑–∞–Ω–∏–º–∞–µ—Ç –ø–µ—Ä–≤—ã–µ –º–µ—Å—Ç–∞ –≤ –∫–ª–∞–Ω —Ç–æ–ø–µ, –∞–∫—Ç–∏–≤–Ω—ã–π. –í –∫–ª–∞–Ω–µ –º–Ω–æ–≥–æ –ø–≤–ø—à–µ—Ä–æ–≤, –±–∏–ª–¥–µ—Ä–æ–≤.
–ü—Ä–æ—Å—å–±–∞! –ù–µ –Ω–∞—Ä—É—à–∞—Ç—å —Ç–æ, —á—Ç–æ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ –Ω–∏–∂–µ

–ù–µ–ª—å–∑—è –±–∏—Ç—å —Å–æ–∫–ª–∞–Ω–æ–≤üö´
–ù–µ–ª—å–∑—è –ª–æ–º–∞—Ç—å —Å–ø–∞–≤–Ω –∫–ª–∞–Ω–∞üö´
–ù–µ–ª—å–∑—è –∑–∞—Å–æ—Ä—è—Ç—å –∫–ª–∞–Ω –±–æ—Ç–∞üö´
–ù–µ–ª—å–∑—è –∑–∞—Å–æ—Ä—è—Ç—å –∫–ª–∞–Ω —Ö–æ–ºüö´

–ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ –∫–ª–∞–Ω—É, –º–æ–∂–µ—Ç–µ —É—Ç–æ—á–Ω–∏—Ç—å –∏—Ö –≤ –±–æ—Ç–µ
"""

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ —Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
INITIAL_BLACKLIST_CLAN = [
    "skibidi0999", "itz_boba_pro", "Kusyuchka", "Mafour134", "MrNorz",
    "Marshal_PPP", "Dimasik216", "Dimasik136", "fanCYBERPUNK4r", "standoff_twink",
    "DreamKing345", "1221", "koIya999", "aliwadzudo", "1230004442",
    "wingg", "TOMATO32", "sancho5252", "Xx_murad2006_xX", "RedSlime333",
    "makar86", "PVPhackerTOP", "Luna4ka", "artkuz111", "EgorKir",
    "giornos", "zimoniks", "MrSabuk", "212334", "VitaHamus",
    "sasha_mahota", "aserot", "offnik2", "Mistik_XX", "kaktys1234",
    "shiinoz01"
]

INITIAL_BLACKLIST_STAFF = [
    "anibellkaff", "meowkmeowk", "FunT1K_812", "_uwugg",
    "Kornelya1", "solwxsd", "dox1ngX", "mrakkk"
]


class Database:
    def __init__(self, db_path="bot_database.db"):
        self.db_path = db_path
        self.init_database()
        self.init_blacklist_tables()
        self.init_initial_blacklists()

    def init_database(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()

        # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER UNIQUE,
                username TEXT,
                first_name TEXT,
                last_name TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # –¢–∞–±–ª–∏—Ü–∞ –∑–∞—è–≤–æ–∫
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS applications (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                application_text TEXT,
                status TEXT DEFAULT 'pending',
                reviewed_by INTEGER,
                reviewed_at TIMESTAMP,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # –¢–∞–±–ª–∏—Ü–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS questions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                question_text TEXT,
                status TEXT DEFAULT 'unanswered',
                reviewed_by INTEGER,
                reviewed_at TIMESTAMP,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # –¢–∞–±–ª–∏—Ü–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS banned_users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER UNIQUE,
                username TEXT,
                reason TEXT,
                banned_by INTEGER,
                banned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # –¢–∞–±–ª–∏—Ü–∞ –ª–æ–≥–æ–≤ –¥–µ–π—Å—Ç–≤–∏–π
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS action_logs (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                action TEXT,
                details TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # –¢–∞–±–ª–∏—Ü–∞ —Ñ–∏–¥–±–µ–∫–∞
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS feedback (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                feedback_text TEXT,
                rating INTEGER,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # –¢–∞–±–ª–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS bot_settings (
                key TEXT PRIMARY KEY,
                value TEXT
            )
        ''')

        conn.commit()
        conn.close()
        print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")

    def init_blacklist_tables(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü —á–µ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()

        # –¢–∞–±–ª–∏—Ü–∞ –ß–°–ö (–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª–∞–Ω–∞)
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS blacklist_clan (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username TEXT UNIQUE,
                reason TEXT DEFAULT '–í —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ –∫–ª–∞–Ω–∞',
                added_by INTEGER,
                added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # –¢–∞–±–ª–∏—Ü–∞ –ß–°–ö–ö (–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥—ã –∫–ª–∞–Ω–∞)
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS blacklist_staff (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username TEXT UNIQUE,
                reason TEXT DEFAULT '–í —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ –∫–æ–º–∞–Ω–¥—ã',
                added_by INTEGER,
                added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        conn.commit()
        conn.close()
        print("‚úÖ –¢–∞–±–ª–∏—Ü—ã —á–µ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")

    def init_initial_blacklists(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö —á–µ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤"""
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ß–°–ö
        for username in INITIAL_BLACKLIST_CLAN:
            self.execute_query(
                "INSERT OR IGNORE INTO blacklist_clan (username, reason, added_by) VALUES (?, ?, ?)",
                (username.lower(), "–ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ß–°–ö", 0)
            )

        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ß–°–ö–ö
        for username in INITIAL_BLACKLIST_STAFF:
            self.execute_query(
                "INSERT OR IGNORE INTO blacklist_staff (username, reason, added_by) VALUES (?, ?, ?)",
                (username.lower(), "–ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ß–°–ö–ö", 0)
            )

        print("‚úÖ –ù–∞—á–∞–ª—å–Ω—ã–µ —á–µ—Ä–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã")

    def execute_query(self, query, params=(), fetch=False):
        """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute(query, params)

        if fetch:
            result = cursor.fetchall()
            columns = [description[0] for description in cursor.description]
            result = [dict(zip(columns, row)) for row in result]
        else:
            result = None

        conn.commit()
        conn.close()
        return result

    def log_action(self, user_id, action, details=""):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π"""
        self.execute_query(
            "INSERT INTO action_logs (user_id, action, details) VALUES (?, ?, ?)",
            (user_id, action, details)
        )

    def add_user(self, user_id, username, first_name, last_name):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        self.execute_query(
            "INSERT OR IGNORE INTO users (user_id, username, first_name, last_name) VALUES (?, ?, ?, ?)",
            (user_id, username, first_name, last_name)
        )

    def add_application(self, user_id, application_text):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏"""
        self.execute_query(
            "INSERT INTO applications (user_id, application_text) VALUES (?, ?)",
            (user_id, application_text)
        )

    def add_question(self, user_id, question_text):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞"""
        self.execute_query(
            "INSERT INTO questions (user_id, question_text) VALUES (?, ?)",
            (user_id, question_text)
        )

    def add_feedback(self, user_id, feedback_text, rating=None):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–¥–±–µ–∫–∞"""
        self.execute_query(
            "INSERT INTO feedback (user_id, feedback_text, rating) VALUES (?, ?, ?)",
            (user_id, feedback_text, rating)
        )

    def get_pending_applications(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞—è–≤–æ–∫"""
        return self.execute_query(
            "SELECT a.*, u.username, u.first_name, u.last_name, "
            "ru.username as reviewer_username, ru.first_name as reviewer_first_name, ru.last_name as reviewer_last_name "
            "FROM applications a "
            "LEFT JOIN users u ON a.user_id = u.user_id "
            "LEFT JOIN users ru ON a.reviewed_by = ru.user_id "
            "WHERE a.status = 'pending' "
            "ORDER BY a.created_at",
            fetch=True
        )

    def get_unanswered_questions(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤"""
        return self.execute_query(
            "SELECT q.*, u.username, u.first_name, u.last_name, "
            "ru.username as reviewer_username, ru.first_name as reviewer_first_name, ru.last_name as reviewer_last_name "
            "FROM questions q "
            "LEFT JOIN users u ON q.user_id = u.user_id "
            "LEFT JOIN users ru ON q.reviewed_by = ru.user_id "
            "WHERE q.status = 'unanswered' "
            "ORDER BY q.created_at",
            fetch=True
        )

    def get_application(self, app_id):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ –ø–æ ID"""
        result = self.execute_query(
            "SELECT a.*, u.username FROM applications a "
            "LEFT JOIN users u ON a.user_id = u.user_id "
            "WHERE a.id = ?",
            (app_id,),
            fetch=True
        )
        return result[0] if result else None

    def get_question(self, question_id):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ ID"""
        result = self.execute_query(
            "SELECT q.*, u.username FROM questions q "
            "LEFT JOIN users u ON q.user_id = u.user_id "
            "WHERE q.id = ?",
            (question_id,),
            fetch=True
        )
        return result[0] if result else None

    def get_admin_info(self, admin_id):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–µ"""
        result = self.execute_query(
            "SELECT username, first_name, last_name FROM users WHERE user_id = ?",
            (admin_id,),
            fetch=True
        )
        return result[0] if result else None

    def get_moderator_info(self, moderator_id):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–µ"""
        result = self.execute_query(
            "SELECT username, first_name, last_name FROM users WHERE user_id = ?",
            (moderator_id,),
            fetch=True
        )
        return result[0] if result else None

    def update_application_status(self, app_id, status, reviewed_by=None):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏"""
        if reviewed_by:
            self.execute_query(
                "UPDATE applications SET status = ?, reviewed_by = ?, reviewed_at = CURRENT_TIMESTAMP WHERE id = ?",
                (status, reviewed_by, app_id)
            )
        else:
            self.execute_query(
                "UPDATE applications SET status = ? WHERE id = ?",
                (status, app_id)
            )

    def update_question_status(self, question_id, status, reviewed_by=None):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤–æ–ø—Ä–æ—Å–∞"""
        if reviewed_by:
            self.execute_query(
                "UPDATE questions SET status = ?, reviewed_by = ?, reviewed_at = CURRENT_TIMESTAMP WHERE id = ?",
                (status, reviewed_by, question_id)
            )
        else:
            self.execute_query(
                "UPDATE questions SET status = ? WHERE id = ?",
                (status, question_id)
            )

    def start_review_application(self, app_id, reviewer_id):
        """–ù–∞—á–∞—Ç—å —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏"""
        self.execute_query(
            "UPDATE applications SET reviewed_by = ?, reviewed_at = CURRENT_TIMESTAMP WHERE id = ?",
            (reviewer_id, app_id)
        )

    def start_review_question(self, question_id, reviewer_id):
        """–ù–∞—á–∞—Ç—å —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞"""
        self.execute_query(
            "UPDATE questions SET reviewed_by = ?, reviewed_at = CURRENT_TIMESTAMP WHERE id = ?",
            (reviewer_id, question_id)
        )

    def get_all_users(self, limit=50, offset=0, search_query=None):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –∏ –ø–æ–∏—Å–∫–æ–º"""
        query = """
            SELECT user_id, username, first_name, last_name, created_at 
            FROM users 
        """
        params = []

        if search_query:
            query += " WHERE username LIKE ? OR first_name LIKE ? OR last_name LIKE ?"
            search_term = f"%{search_query}%"
            params = [search_term, search_term, search_term]

        query += " ORDER BY created_at DESC LIMIT ? OFFSET ?"
        params.extend([limit, offset])

        return self.execute_query(query, params, fetch=True)

    def get_users_count(self, search_query=None):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        query = "SELECT COUNT(*) as count FROM users"
        params = []

        if search_query:
            query += " WHERE username LIKE ? OR first_name LIKE ? OR last_name LIKE ?"
            search_term = f"%{search_query}%"
            params = [search_term, search_term, search_term]

        result = self.execute_query(query, params, fetch=True)
        return result[0]['count'] if result else 0

    def get_recent_users(self, days=7):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π"""
        return self.execute_query(
            "SELECT user_id, username, first_name, last_name, created_at FROM users WHERE created_at >= datetime('now', ?)",
            (f'-{days} days',),
            fetch=True
        )

    def get_user_stats(self, user_id):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
        stats = {}

        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫
        result = self.execute_query(
            "SELECT COUNT(*) as count FROM applications WHERE user_id = ?",
            (user_id,),
            fetch=True
        )
        stats['applications_count'] = result[0]['count'] if result else 0

        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤
        result = self.execute_query(
            "SELECT COUNT(*) as count FROM questions WHERE user_id = ?",
            (user_id,),
            fetch=True
        )
        stats['questions_count'] = result[0]['count'] if result else 0

        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏–¥–±–µ–∫–æ–≤
        result = self.execute_query(
            "SELECT COUNT(*) as count FROM feedback WHERE user_id = ?",
            (user_id,),
            fetch=True
        )
        stats['feedback_count'] = result[0]['count'] if result else 0

        # –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        result = self.execute_query(
            "SELECT MAX(created_at) as last_activity FROM ("
            "SELECT created_at FROM applications WHERE user_id = ? "
            "UNION ALL "
            "SELECT created_at FROM questions WHERE user_id = ? "
            "UNION ALL "
            "SELECT created_at FROM feedback WHERE user_id = ?"
            ")",
            (user_id, user_id, user_id),
            fetch=True
        )
        stats['last_activity'] = result[0]['last_activity'] if result else None

        return stats

    def get_stats(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        stats = {}

        result = self.execute_query("SELECT COUNT(*) as count FROM users", fetch=True)
        stats['total_users'] = result[0]['count'] if result else 0

        result = self.execute_query("SELECT COUNT(*) as count FROM applications", fetch=True)
        stats['total_applications'] = result[0]['count'] if result else 0

        result = self.execute_query("SELECT COUNT(*) as count FROM questions", fetch=True)
        stats['total_questions'] = result[0]['count'] if result else 0

        result = self.execute_query("SELECT COUNT(*) as count FROM feedback", fetch=True)
        stats['total_feedback'] = result[0]['count'] if result else 0

        result = self.execute_query(
            "SELECT COUNT(*) as count FROM applications WHERE status = 'pending'",
            fetch=True
        )
        stats['pending_applications'] = result[0]['count'] if result else 0

        result = self.execute_query(
            "SELECT COUNT(*) as count FROM questions WHERE status = 'unanswered'",
            fetch=True
        )
        stats['unanswered_questions'] = result[0]['count'] if result else 0

        result = self.execute_query("SELECT COUNT(*) as count FROM banned_users", fetch=True)
        stats['banned_users'] = result[0]['count'] if result else 0

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
        result = self.execute_query(
            "SELECT COUNT(*) as count FROM users WHERE DATE(created_at) = DATE('now')",
            fetch=True
        )
        stats['new_users_today'] = result[0]['count'] if result else 0

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é
        result = self.execute_query(
            "SELECT COUNT(*) as count FROM users WHERE created_at >= datetime('now', '-7 days')",
            fetch=True
        )
        stats['new_users_week'] = result[0]['count'] if result else 0

        # –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ —Ñ–∏–¥–±–µ–∫–∞
        result = self.execute_query(
            "SELECT AVG(rating) as avg_rating FROM feedback WHERE rating IS NOT NULL",
            fetch=True
        )
        stats['avg_feedback_rating'] = round(result[0]['avg_rating'], 2) if result and result[0]['avg_rating'] else 0

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–µ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤
        result = self.execute_query("SELECT COUNT(*) as count FROM blacklist_clan", fetch=True)
        stats['blacklist_clan_count'] = result[0]['count'] if result else 0

        result = self.execute_query("SELECT COUNT(*) as count FROM blacklist_staff", fetch=True)
        stats['blacklist_staff_count'] = result[0]['count'] if result else 0

        return stats

    def ban_user(self, user_id, username, reason, banned_by):
        """–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        self.execute_query(
            "INSERT OR REPLACE INTO banned_users (user_id, username, reason, banned_by) VALUES (?, ?, ?, ?)",
            (user_id, username, reason, banned_by)
        )

    def unban_user(self, user_id):
        """–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        self.execute_query(
            "DELETE FROM banned_users WHERE user_id = ?",
            (user_id,)
        )

    def is_user_banned(self, user_id):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"""
        result = self.execute_query(
            "SELECT * FROM banned_users WHERE user_id = ?",
            (user_id,),
            fetch=True
        )
        return len(result) > 0

    def get_banned_users(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        return self.execute_query(
            "SELECT bu.*, u.username as banned_by_username FROM banned_users bu "
            "LEFT JOIN users u ON bu.banned_by = u.user_id "
            "ORDER BY bu.banned_at DESC",
            fetch=True
        )

    def get_user_by_username(self, username):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ username"""
        result = self.execute_query(
            "SELECT * FROM users WHERE username = ?",
            (username.lstrip('@'),),
            fetch=True
        )
        return result[0] if result else None

    def get_user_by_id(self, user_id):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID"""
        result = self.execute_query(
            "SELECT * FROM users WHERE user_id = ?",
            (user_id,),
            fetch=True
        )
        return result[0] if result else None

    def get_action_logs(self, limit=50):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –¥–µ–π—Å—Ç–≤–∏–π"""
        return self.execute_query(
            "SELECT al.*, u.username, u.first_name, u.last_name FROM action_logs al "
            "LEFT JOIN users u ON al.user_id = u.user_id "
            "ORDER BY al.created_at DESC LIMIT ?",
            (limit,),
            fetch=True
        )

    def get_feedback(self, limit=20):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∏–¥–±–µ–∫–∞"""
        return self.execute_query(
            "SELECT f.*, u.username, u.first_name, u.last_name FROM feedback f "
            "LEFT JOIN users u ON f.user_id = u.user_id "
            "ORDER BY f.created_at DESC LIMIT ?",
            (limit,),
            fetch=True
        )

    def clear_old_data(self, days=30):
        """–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        deleted_apps = self.execute_query(
            "DELETE FROM applications WHERE created_at < datetime('now', ?) AND status != 'pending'",
            (f'-{days} days',)
        )
        deleted_questions = self.execute_query(
            "DELETE FROM questions WHERE created_at < datetime('now', ?) AND status != 'unanswered'",
            (f'-{days} days',)
        )
        deleted_logs = self.execute_query(
            "DELETE FROM action_logs WHERE created_at < datetime('now', ?)",
            (f'-{days} days',)
        )
        return {
            'deleted_applications': deleted_apps,
            'deleted_questions': deleted_questions,
            'deleted_logs': deleted_logs
        }

    def get_setting(self, key, default=None):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
        result = self.execute_query(
            "SELECT value FROM bot_settings WHERE key = ?",
            (key,),
            fetch=True
        )
        return result[0]['value'] if result else default

    def set_setting(self, key, value):
        """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
        self.execute_query(
            "INSERT OR REPLACE INTO bot_settings (key, value) VALUES (?, ?)",
            (key, value)
        )

    # --- –ú–µ—Ç–æ–¥—ã –¥–ª—è —á–µ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ ---
    def add_to_blacklist(self, username, list_type, reason, added_by):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫"""
        table = "blacklist_clan" if list_type == BLACKLIST_CLAN else "blacklist_staff"
        try:
            self.execute_query(
                f"INSERT OR REPLACE INTO {table} (username, reason, added_by) VALUES (?, ?, ?)",
                (username.lower(), reason, added_by)
            )
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –ß–°: {e}")
            return False

    def remove_from_blacklist(self, username, list_type):
        """–£–¥–∞–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ –∏–∑ —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞"""
        table = "blacklist_clan" if list_type == BLACKLIST_CLAN else "blacklist_staff"
        try:
            self.execute_query(
                f"DELETE FROM {table} WHERE username = ?",
                (username.lower(),)
            )
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –ß–°: {e}")
            return False

    def get_blacklist(self, list_type):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ–≥–æ —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞"""
        table = "blacklist_clan" if list_type == BLACKLIST_CLAN else "blacklist_staff"
        return self.execute_query(
            f"SELECT * FROM {table} ORDER BY username",
            fetch=True
        )

    def check_in_blacklist(self, username, list_type):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏–≥—Ä–æ–∫–∞ –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ"""
        table = "blacklist_clan" if list_type == BLACKLIST_CLAN else "blacklist_staff"
        result = self.execute_query(
            f"SELECT * FROM {table} WHERE username = ?",
            (username.lower(),),
            fetch=True
        )
        return len(result) > 0

    def search_in_blacklist(self, search_term, list_type):
        """–ü–æ–∏—Å–∫ –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ"""
        table = "blacklist_clan" if list_type == BLACKLIST_CLAN else "blacklist_staff"
        return self.execute_query(
            f"SELECT * FROM {table} WHERE username LIKE ? ORDER BY username",
            (f"%{search_term.lower()}%",),
            fetch=True
        )


# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
db = Database()


class MinecraftBot:
    def __init__(self):
        self.application = None
        self.maintenance_mode = False
        self.bot_username = "MinecraftDyO_Bot"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π username –≤–∞—à–µ–≥–æ –±–æ—Ç–∞

    def setup_handlers(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤"""
        conv_handler = ConversationHandler(
            entry_points=[
                MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_message)
            ],
            states={
                QUESTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.receive_question)],
                MODERATION: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.receive_moderation)],
                BROADCAST: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.receive_broadcast)],
                USER_SEARCH: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.receive_user_search)],
                FEEDBACK: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.receive_feedback)],
                ADD_TO_BLACKLIST: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.receive_blacklist_add)],
                REMOVE_FROM_BLACKLIST: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.receive_blacklist_remove)],
                BLACKLIST_SEARCH: [MessageHandler(filters.TEXT & ~filters.COMMAND, self.receive_blacklist_search)],
            },
            fallbacks=[CommandHandler("cancel", self.cancel)]
        )

        # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
        self.application.add_handler(CommandHandler("start", self.start))
        self.application.add_handler(CommandHandler("help", self.help_command))
        self.application.add_handler(CommandHandler("menu", self.show_menu))
        self.application.add_handler(CommandHandler("rules", self.show_rules))
        self.application.add_handler(CommandHandler("ping", self.ping))
        self.application.add_handler(CommandHandler("feedback", self.feedback))
        self.application.add_handler(CommandHandler("status", self.bot_status))
        self.application.add_handler(CommandHandler("id", self.get_user_id))

        # –ö–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
        self.application.add_handler(CommandHandler("admin", self.admin_panel))
        self.application.add_handler(CommandHandler("moderator", self.moderator_panel))
        self.application.add_handler(CommandHandler("blacklist", self.show_blacklist_menu))
        self.application.add_handler(CommandHandler("stats", self.stats))
        self.application.add_handler(CommandHandler("addadmin", self.add_admin))
        self.application.add_handler(CommandHandler("addmoderator", self.add_moderator))
        self.application.add_handler(CommandHandler("removeadmin", self.remove_admin))
        self.application.add_handler(CommandHandler("removemoderator", self.remove_moderator))
        self.application.add_handler(CommandHandler("admins", self.show_admins))
        self.application.add_handler(CommandHandler("moderators", self.show_moderators))
        self.application.add_handler(CommandHandler("ban", self.ban_user_command))
        self.application.add_handler(CommandHandler("unban", self.unban_user_command))
        self.application.add_handler(CommandHandler("banned", self.show_banned_users))
        self.application.add_handler(CommandHandler("users", self.show_users))
        self.application.add_handler(CommandHandler("finduser", self.find_user))
        self.application.add_handler(CommandHandler("userinfo", self.user_info))
        self.application.add_handler(CommandHandler("recentusers", self.recent_users))
        self.application.add_handler(CommandHandler("broadcast", self.broadcast))
        self.application.add_handler(CommandHandler("logs", self.show_logs))
        self.application.add_handler(CommandHandler("cleanup", self.cleanup_data))
        self.application.add_handler(CommandHandler("export", self.export_data))
        self.application.add_handler(CommandHandler("maintenance", self.maintenance_mode_command))
        self.application.add_handler(CommandHandler("feedback_list", self.show_feedback))
        self.application.add_handler(CommandHandler("notify", self.notify_user))
        self.application.add_handler(CommandHandler("backup", self.backup_database))

        self.application.add_handler(CallbackQueryHandler(self.button_handler))
        self.application.add_handler(conv_handler)

    def main_keyboard(self, user_id):
        """–û—Å–Ω–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å —É—á–µ—Ç–æ–º –ø—Ä–∞–≤"""
        keyboard = [
            [KeyboardButton("‚ùì –í–æ–ø—Ä–æ—Å"), KeyboardButton("üìù –ù–∞–±–æ—Ä –≤ –º–æ–¥–µ—Ä–∞—Ü–∏—é")],
            [KeyboardButton("üìú –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞–Ω–µ"), KeyboardButton("üí¨ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å")],
            [KeyboardButton("‚ÑπÔ∏è –û –±–æ—Ç–µ")]
        ]

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
        if user_id in ADMIN_IDS:
            keyboard.insert(2, [KeyboardButton("üëë –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")])

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
        if user_id in MODERATOR_IDS:
            keyboard.insert(2, [KeyboardButton("üõ°Ô∏è –ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞")])

        return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

    def admin_keyboard(self):
        """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏"""
        keyboard = [
            [InlineKeyboardButton("üìã –ó–∞—è–≤–∫–∏", callback_data="admin_applications")],
            [InlineKeyboardButton("‚ùì –í–æ–ø—Ä–æ—Å—ã", callback_data="admin_questions")],
            [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats")],
            [InlineKeyboardButton("üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ", callback_data="admin_banned")],
            [InlineKeyboardButton("üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", callback_data="admin_users")],
            [InlineKeyboardButton("üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", callback_data="admin_search_user")],
            [InlineKeyboardButton("üÜï –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", callback_data="admin_recent_users")],
            [InlineKeyboardButton("üí¨ –§–∏–¥–±–µ–∫", callback_data="admin_feedback")],
            [InlineKeyboardButton("üìù –õ–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π", callback_data="admin_logs")],
            [InlineKeyboardButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data="admin_settings")],
            [InlineKeyboardButton("üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ß–°", callback_data="admin_blacklist_menu")],
            [InlineKeyboardButton("üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º–∏", callback_data="admin_moderators")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_back")]
        ]
        return InlineKeyboardMarkup(keyboard)

    def moderator_keyboard(self):
        """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞"""
        keyboard = [
            [InlineKeyboardButton("üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –ß–°–ö", callback_data="mod_view_clan")],
            [InlineKeyboardButton("üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –ß–°–ö–ö", callback_data="mod_view_staff")],
            [InlineKeyboardButton("üîç –ü–æ–∏—Å–∫ –≤ –ß–°", callback_data="mod_search_blacklist")],
            [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ß–°", callback_data="mod_blacklist_stats")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="mod_back")]
        ]
        return InlineKeyboardMarkup(keyboard)

    def blacklist_menu_keyboard(self):
        """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–Ω—ã–º–∏ —Å–ø–∏—Å–∫–∞–º–∏"""
        keyboard = [
            [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –ß–°–ö", callback_data="bl_add_clan")],
            [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –ß–°–ö–ö", callback_data="bl_add_staff")],
            [InlineKeyboardButton("‚ûñ –£–¥–∞–ª–∏—Ç—å –∏–∑ –ß–°–ö", callback_data="bl_remove_clan")],
            [InlineKeyboardButton("‚ûñ –£–¥–∞–ª–∏—Ç—å –∏–∑ –ß–°–ö–ö", callback_data="bl_remove_staff")],
            [InlineKeyboardButton("üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –ß–°–ö", callback_data="bl_view_clan")],
            [InlineKeyboardButton("üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –ß–°–ö–ö", callback_data="bl_view_staff")],
            [InlineKeyboardButton("üîç –ü–æ–∏—Å–∫ –≤ –ß–°", callback_data="bl_search")],
            [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ß–°", callback_data="bl_stats")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_back")]
        ]
        return InlineKeyboardMarkup(keyboard)

    def settings_keyboard(self):
        """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        maintenance_status = "üü¢ –í—ã–∫–ª" if not self.maintenance_mode else "üî¥ –í–∫–ª"
        keyboard = [
            [InlineKeyboardButton(f"üîß –†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è: {maintenance_status}", callback_data="toggle_maintenance")],
            [InlineKeyboardButton("üóÉÔ∏è –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö", callback_data="export_data")],
            [InlineKeyboardButton("üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö", callback_data="cleanup_data")],
            [InlineKeyboardButton("üíæ –ë—ç–∫–∞–ø –ë–î", callback_data="backup_db")],
            [InlineKeyboardButton("üîô –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_back")]
        ]
        return InlineKeyboardMarkup(keyboard)

    def feedback_keyboard(self):
        """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Ñ–∏–¥–±–µ–∫–∞"""
        keyboard = [
            [InlineKeyboardButton("‚≠ê 1", callback_data="feedback_1"),
             InlineKeyboardButton("‚≠ê 2", callback_data="feedback_2"),
             InlineKeyboardButton("‚≠ê 3", callback_data="feedback_3")],
            [InlineKeyboardButton("‚≠ê 4", callback_data="feedback_4"),
             InlineKeyboardButton("‚≠ê 5", callback_data="feedback_5")],
            [InlineKeyboardButton("üí¨ –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç", callback_data="feedback_text")],
            [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="feedback_cancel")]
        ]
        return InlineKeyboardMarkup(keyboard)

    def users_keyboard(self, page=0, total_pages=1, search_query=None):
        """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"""
        keyboard = []

        # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        nav_buttons = []
        if page > 0:
            nav_buttons.append(
                InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"users_page_{page - 1}_{search_query or ''}"))

        nav_buttons.append(InlineKeyboardButton(f"{page + 1}/{total_pages}", callback_data="users_info"))

        if page < total_pages - 1:
            nav_buttons.append(
                InlineKeyboardButton("–í–ø–µ—Ä–µ–¥ ‚û°Ô∏è", callback_data=f"users_page_{page + 1}_{search_query or ''}"))

        if nav_buttons:
            keyboard.append(nav_buttons)

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        keyboard.extend([
            [InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="admin_users")],
            [InlineKeyboardButton("üîç –ü–æ–∏—Å–∫", callback_data="admin_search_user")],
            [InlineKeyboardButton("üîô –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_back")]
        ])

        return InlineKeyboardMarkup(keyboard)

    def blacklist_view_keyboard(self, list_type, page=0, total_pages=1):
        """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞"""
        keyboard = []

        # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        nav_buttons = []
        if page > 0:
            nav_buttons.append(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"bl_page_{list_type}_{page - 1}"))

        nav_buttons.append(InlineKeyboardButton(f"{page + 1}/{total_pages}", callback_data="bl_info"))

        if page < total_pages - 1:
            nav_buttons.append(InlineKeyboardButton("–í–ø–µ—Ä–µ–¥ ‚û°Ô∏è", callback_data=f"bl_page_{list_type}_{page + 1}"))

        if nav_buttons:
            keyboard.append(nav_buttons)

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ callback –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        add_callback = f"bl_add_{list_type}"
        remove_callback = f"bl_remove_{list_type}"

        # –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        keyboard.extend([
            [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å", callback_data=add_callback),
             InlineKeyboardButton("‚ûñ –£–¥–∞–ª–∏—Ç—å", callback_data=remove_callback)],
            [InlineKeyboardButton("üîç –ü–æ–∏—Å–∫", callback_data="bl_search")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_blacklist_menu")]
        ])

        return InlineKeyboardMarkup(keyboard)

    def cancel_keyboard(self):
        """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã –¥–µ–π—Å—Ç–≤–∏—è"""
        keyboard = [[KeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å")]]
        return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

    def format_admin_name(self, admin_id, admin_info=None):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å —É—á–µ—Ç–æ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö ID"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ ID
        if admin_id in ADMIN_USERNAME_MAP:
            return ADMIN_USERNAME_MAP[admin_id]

        # –ï—Å–ª–∏ –Ω–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–∑—ã
        if not admin_info:
            admin_info = db.get_admin_info(admin_id)

        if not admin_info:
            return f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (ID: {admin_id})"

        username = admin_info.get('username')
        first_name = admin_info.get('first_name')
        last_name = admin_info.get('last_name')

        if username:
            return f"@{username}"
        elif first_name and last_name:
            return f"{first_name} {last_name}"
        elif first_name:
            return first_name
        else:
            return f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (ID: {admin_id})"

    def format_moderator_name(self, moderator_id, moderator_info=None):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞ —Å —É—á–µ—Ç–æ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö ID"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ ID
        if moderator_id in MODERATOR_USERNAME_MAP:
            return MODERATOR_USERNAME_MAP[moderator_id]

        # –ï—Å–ª–∏ –Ω–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–∑—ã
        if not moderator_info:
            moderator_info = db.get_moderator_info(moderator_id)

        if not moderator_info:
            return f"–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä (ID: {moderator_id})"

        username = moderator_info.get('username')
        first_name = moderator_info.get('first_name')
        last_name = moderator_info.get('last_name')

        if username:
            return f"@{username}"
        elif first_name and last_name:
            return f"{first_name} {last_name}"
        elif first_name:
            return first_name
        else:
            return f"–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä (ID: {moderator_id})"

    # ==================== –ü–†–û–í–ï–†–ö–ê –¢–ò–ü–ê –ß–ê–¢–ê ====================
    async def check_private_chat(self, update: Update) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ —ç—Ç–æ –õ–°."""
        if update.effective_chat.type != "private":
            await update.message.reply_text(
                f"‚ùå –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.\n"
                f"–ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ –≤ –õ–°: @{self.bot_username}"
            )
            return False
        return True

    # ============================================================

    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user = update.message.from_user

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
        if self.maintenance_mode and user.id not in ADMIN_IDS:
            await update.message.reply_text(
                "üî¥ –ë–æ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è. "
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.\n\n"
                "–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞!"
            )
            return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if db.is_user_banned(user.id):
            await update.message.reply_text("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –±–æ—Ç–∞.")
            return

        db.add_user(user.id, user.username, user.first_name, user.last_name)
        db.log_action(user.id, "start", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")

        welcome_text = (
            "üéÆ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –∫–ª–∞–Ω–∞ Minecraft dyO!\n\n"
            "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ:\n"
            "‚Ä¢ üìù –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –≤ –º–æ–¥–µ—Ä–∞—Ü–∏—é\n"
            "‚Ä¢ ‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏\n"
            "‚Ä¢ üìú –û–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–ª–∞–Ω–µ\n"
            "‚Ä¢ üí¨ –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –æ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é –Ω–∏–∂–µ üëá"
        )

        if user.id in ADMIN_IDS:
            welcome_text += "\n\nüëë –£ –≤–∞—Å –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!"
        elif user.id in MODERATOR_IDS:
            welcome_text += "\n\nüõ°Ô∏è –£ –≤–∞—Å –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞!"

        await update.message.reply_text(
            welcome_text,
            reply_markup=self.main_keyboard(user.id)
        )

    async def show_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if db.is_user_banned(user_id):
            await update.message.reply_text("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –±–æ—Ç–∞.")
            return

        await update.message.reply_text(
            "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –±–æ—Ç–∞ –∫–ª–∞–Ω–∞ Minecraft dyO",
            reply_markup=self.main_keyboard(user_id)
        )

    async def show_rules(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –∫–ª–∞–Ω–∞"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if db.is_user_banned(user_id):
            await update.message.reply_text("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –±–æ—Ç–∞.")
            return

        # –†–∞–∑–±–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ —á–∞—Å—Ç–∏, –µ—Å–ª–∏ –æ–Ω–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        if len(CLAN_RULES) > 4000:
            rules_parts = [CLAN_RULES[i:i + 4000] for i in range(0, len(CLAN_RULES), 4000)]
            for i, part in enumerate(rules_parts):
                if i == 0:
                    await update.message.reply_text(part)
                else:
                    await update.message.reply_text(part)
        else:
            await update.message.reply_text(CLAN_RULES)

        await update.message.reply_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞–ª—å–Ω–µ–π—à–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=self.main_keyboard(user_id)
        )

    async def admin_panel(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id
        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        await update.message.reply_text(
            "üëë –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:",
            reply_markup=self.admin_keyboard()
        )

    async def moderator_panel(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id
        if user_id not in MODERATOR_IDS and user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞.")
            return

        await update.message.reply_text(
            "üõ°Ô∏è –ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞:",
            reply_markup=self.moderator_keyboard()
        )

    async def show_blacklist_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–Ω—ã–º–∏ —Å–ø–∏—Å–∫–∞–º–∏"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id
        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        await update.message.reply_text(
            "üìã –£–ü–†–ê–í–õ–ï–ù–ò–ï –ß–ï–†–ù–´–ú–ò –°–ü–ò–°–ö–ê–ú–ò\n\n"
            "–ß–°–ö (–ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª–∞–Ω–∞) - –∏–≥—Ä–æ–∫–æ–≤ –Ω–µ–ª—å–∑—è –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –∫–ª–∞–Ω\n"
            "–ß–°–ö–ö (–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥—ã –∫–ª–∞–Ω–∞) - –Ω–µ–ª—å–∑—è –ø—Ä–∏–Ω–∏–º–∞—Ç—å –Ω–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏",
            reply_markup=self.blacklist_menu_keyboard()
        )

    async def stats(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id
        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        stats = db.get_stats()
        await update.message.reply_text(
            f"üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–û–¢–ê:\n\n"
            f"üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['total_users']}\n"
            f"üìù –ó–∞—è–≤–æ–∫: {stats['total_applications']}\n"
            f"‚ùì –í–æ–ø—Ä–æ—Å–æ–≤: {stats['total_questions']}\n"
            f"üí¨ –û—Ç–∑—ã–≤–æ–≤: {stats['total_feedback']}\n"
            f"‚è≥ –ù–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫: {stats['pending_applications']}\n"
            f"‚è≥ –ù–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤: {stats['unanswered_questions']}\n"
            f"üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö: {stats['banned_users']}\n"
            f"üÜï –ù–æ–≤—ã—Ö —Å–µ–≥–æ–¥–Ω—è: {stats['new_users_today']}\n"
            f"üìà –ù–æ–≤—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é: {stats['new_users_week']}\n"
            f"‚≠ê –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: {stats['avg_feedback_rating']}/5\n\n"
            f"üìã –ß–ï–†–ù–´–ï –°–ü–ò–°–ö–ò:\n"
            f"‚ùå –ß–°–ö: {stats['blacklist_clan_count']} –∏–≥—Ä–æ–∫–æ–≤\n"
            f"üö´ –ß–°–ö–ö: {stats['blacklist_staff_count']} –∏–≥—Ä–æ–∫–æ–≤"
        )

    async def add_admin(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
            return

        if not context.args:
            await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /addadmin <user_id> [username]")
            return

        try:
            new_admin_id = int(context.args[0])
            if new_admin_id not in ADMIN_IDS:
                ADMIN_IDS.append(new_admin_id)

                # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω username, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–∞—Ä—Ç—É
                if len(context.args) > 1:
                    username = context.args[1]
                    if not username.startswith('@'):
                        username = f"@{username}"
                    ADMIN_USERNAME_MAP[new_admin_id] = username

                await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {new_admin_id} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã.")
                db.log_action(user_id, "add_admin", f"–î–æ–±–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω: {new_admin_id}")
            else:
                await update.message.reply_text("‚ùå –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.")
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

    async def remove_admin(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
            return

        if not context.args:
            await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /removeadmin <user_id>")
            return

        try:
            remove_admin_id = int(context.args[0])
            if remove_admin_id in ADMIN_IDS:
                ADMIN_IDS.remove(remove_admin_id)
                # –£–¥–∞–ª—è–µ–º –∏–∑ –∫–∞—Ä—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å
                if remove_admin_id in ADMIN_USERNAME_MAP:
                    del ADMIN_USERNAME_MAP[remove_admin_id]
                await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {remove_admin_id} —É–¥–∞–ª–µ–Ω –∏–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.")
                db.log_action(user_id, "remove_admin", f"–£–¥–∞–ª–µ–Ω –∞–¥–º–∏–Ω: {remove_admin_id}")
            else:
                await update.message.reply_text("‚ùå –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.")
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

    async def add_moderator(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
            return

        if not context.args:
            await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /addmoderator <user_id> [username]")
            return

        try:
            new_moderator_id = int(context.args[0])
            if new_moderator_id not in MODERATOR_IDS:
                MODERATOR_IDS.append(new_moderator_id)

                # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω username, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–∞—Ä—Ç—É
                if len(context.args) > 1:
                    username = context.args[1]
                    if not username.startswith('@'):
                        username = f"@{username}"
                    MODERATOR_USERNAME_MAP[new_moderator_id] = username

                await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {new_moderator_id} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã.")
                db.log_action(user_id, "add_moderator", f"–î–æ–±–∞–≤–ª–µ–Ω –º–æ–¥–µ—Ä–∞—Ç–æ—Ä: {new_moderator_id}")
            else:
                await update.message.reply_text("‚ùå –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä.")
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

    async def remove_moderator(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
            return

        if not context.args:
            await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /removemoderator <user_id>")
            return

        try:
            remove_moderator_id = int(context.args[0])
            if remove_moderator_id in MODERATOR_IDS:
                MODERATOR_IDS.remove(remove_moderator_id)
                # –£–¥–∞–ª—è–µ–º –∏–∑ –∫–∞—Ä—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å
                if remove_moderator_id in MODERATOR_USERNAME_MAP:
                    del MODERATOR_USERNAME_MAP[remove_moderator_id]
                await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {remove_moderator_id} —É–¥–∞–ª–µ–Ω –∏–∑ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤.")
                db.log_action(user_id, "remove_moderator", f"–£–¥–∞–ª–µ–Ω –º–æ–¥–µ—Ä–∞—Ç–æ—Ä: {remove_moderator_id}")
            else:
                await update.message.reply_text("‚ùå –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º.")
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

    async def show_admins(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        # –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–π —Å–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
        admin_list = "üëë –°–ü–ò–°–û–ö –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–û–í:\n\n"

        for i, admin_id in enumerate(ADMIN_IDS, 1):
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–µ –∏–∑ –±–∞–∑—ã
            admin_info = db.get_admin_info(admin_id)

            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            if admin_id in ADMIN_USERNAME_MAP:
                admin_display = ADMIN_USERNAME_MAP[admin_id]
            elif admin_info:
                username = admin_info.get('username')
                first_name = admin_info.get('first_name', '')
                last_name = admin_info.get('last_name', '')

                if username:
                    admin_display = f"@{username}"
                elif first_name or last_name:
                    admin_display = f"{first_name} {last_name}".strip()
                else:
                    admin_display = f"ID: {admin_id}"
            else:
                admin_display = f"ID: {admin_id}"

            # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–º–µ—Ç–∫—É –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            current_marker = " üëà –í—ã" if admin_id == user_id else ""

            admin_list += f"{i}. {admin_display} (ID: {admin_id}){current_marker}\n"

        admin_list += f"\nüìä –í—Å–µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: {len(ADMIN_IDS)}"

        await update.message.reply_text(admin_list)

    async def show_moderators(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        if not MODERATOR_IDS:
            await update.message.reply_text("üìã –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã.")
            return

        # –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–π —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
        moderator_list = "üõ°Ô∏è –°–ü–ò–°–û–ö –ú–û–î–ï–†–ê–¢–û–†–û–í:\n\n"

        for i, moderator_id in enumerate(MODERATOR_IDS, 1):
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–µ –∏–∑ –±–∞–∑—ã
            moderator_info = db.get_moderator_info(moderator_id)

            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            if moderator_id in MODERATOR_USERNAME_MAP:
                moderator_display = MODERATOR_USERNAME_MAP[moderator_id]
            elif moderator_info:
                username = moderator_info.get('username')
                first_name = moderator_info.get('first_name', '')
                last_name = moderator_info.get('last_name', '')

                if username:
                    moderator_display = f"@{username}"
                elif first_name or last_name:
                    moderator_display = f"{first_name} {last_name}".strip()
                else:
                    moderator_display = f"ID: {moderator_id}"
            else:
                moderator_display = f"ID: {moderator_id}"

            moderator_list += f"{i}. {moderator_display} (ID: {moderator_id})\n"

        moderator_list += f"\nüìä –í—Å–µ–≥–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤: {len(MODERATOR_IDS)}"

        await update.message.reply_text(moderator_list)

    async def ban_user_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
            return

        if not context.args or len(context.args) < 2:
            await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /ban @username –ø—Ä–∏—á–∏–Ω–∞_–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏")
            return

        username = context.args[0]
        reason = ' '.join(context.args[1:])

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        user_info = db.get_user_by_username(username)
        if not user_info:
            await update.message.reply_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º username –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        # –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        db.ban_user(user_info['user_id'], user_info['username'], reason, user_id)
        db.log_action(user_id, "ban_user", f"–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: @{username}, –ø—Ä–∏—á–∏–Ω–∞: {reason}")

        admin_name = self.format_admin_name(user_id)
        await update.message.reply_text(
            f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{user_info['username']} (ID: {user_info['user_id']}) –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.\n"
            f"üëÆ‚Äç‚ôÇÔ∏è –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª: {admin_name}\n"
            f"üìù –ü—Ä–∏—á–∏–Ω–∞: {reason}"
        )

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤
        for admin_id in ADMIN_IDS:
            if admin_id != user_id:
                try:
                    await self.application.bot.send_message(
                        admin_id,
                        f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{user_info['username']} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {admin_name}\n"
                        f"üìù –ü—Ä–∏—á–∏–Ω–∞: {reason}"
                    )
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞ {admin_id}: {e}")

    async def unban_user_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
            return

        if not context.args:
            await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /unban @username")
            return

        username = context.args[0]

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        user_info = db.get_user_by_username(username)
        if not user_info:
            await update.message.reply_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º username –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if not db.is_user_banned(user_info['user_id']):
            await update.message.reply_text("‚ùå –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.")
            return

        # –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        db.unban_user(user_info['user_id'])
        db.log_action(user_id, "unban_user", f"–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: @{username}")

        admin_name = self.format_admin_name(user_id)
        await update.message.reply_text(
            f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{user_info['username']} (ID: {user_info['user_id']}) —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.\n"
            f"üëÆ‚Äç‚ôÇÔ∏è –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª: {admin_name}"
        )

    async def show_banned_users(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        banned_users = db.get_banned_users()
        if not banned_users:
            await update.message.reply_text("‚úÖ –ù–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
            return

        banned_list = "üö´ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò:\n\n"
        for banned in banned_users:
            banned_by = f"@{banned['banned_by_username']}" if banned[
                'banned_by_username'] else f"ID: {banned['banned_by']}"
            banned_list += (
                f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{banned['username']} (ID: {banned['user_id']})\n"
                f"üìù –ü—Ä–∏—á–∏–Ω–∞: {banned['reason']}\n"
                f"üëÆ‚Äç‚ôÇÔ∏è –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª: {banned_by}\n"
                f"üìÖ –î–∞—Ç–∞: {banned['banned_at']}\n"
                f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
            )

        await update.message.reply_text(banned_list)

    async def show_users(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        await self.send_users_page(update, context, page=0)

    async def send_users_page(self, update, context, page=0, search_query=None):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"""
        limit = 10
        offset = page * limit

        users = db.get_all_users(limit=limit, offset=offset, search_query=search_query)
        total_users = db.get_users_count(search_query)
        total_pages = (total_users + limit - 1) // limit

        if not users:
            message = "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
            if search_query:
                message = f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É '{search_query}' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
            if isinstance(update, Update):
                await update.message.reply_text(message)
            else:
                await update.edit_message_text(message)
            return

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if search_query:
            message = f"üë• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò (–ø–æ–∏—Å–∫: '{search_query}')\n\n"
        else:
            message = "üë• –í–°–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò –ë–û–¢–ê\n\n"

        for i, user in enumerate(users, start=1):
            user_num = offset + i
            username = f"@{user['username']}" if user['username'] else "–±–µ–∑ username"
            full_name = f"{user['first_name'] or ''} {user['last_name'] or ''}".strip()
            created_date = user['created_at'].split()[0] if user['created_at'] else "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

            message += f"{user_num}. {full_name} ({username})\n"
            message += f"   üÜî: {user['user_id']}\n"
            message += f"   üìÖ: {created_date}\n"

            # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_stats = db.get_user_stats(user['user_id'])
            if user_stats['applications_count'] > 0 or user_stats['questions_count'] > 0:
                message += f"   üìä –ó–∞—è–≤–æ–∫: {user_stats['applications_count']}, –í–æ–ø—Ä–æ—Å–æ–≤: {user_stats['questions_count']}\n"

            message += "\n"

        message += f"üìä –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_users}"
        if total_pages > 1:
            message += f" (–°—Ç—Ä–∞–Ω–∏—Ü–∞ {page + 1} –∏–∑ {total_pages})"

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        if isinstance(update, Update):
            await update.message.reply_text(
                message,
                reply_markup=self.users_keyboard(page, total_pages, search_query)
            )
        else:
            # –ï—Å–ª–∏ —ç—Ç–æ callback query
            await update.edit_message_text(
                message,
                reply_markup=self.users_keyboard(page, total_pages, search_query)
            )

    async def find_user(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return ConversationHandler.END

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return ConversationHandler.END

        if not context.args:
            await update.message.reply_text(
                "üîç –í–≤–µ–¥–∏—Ç–µ username, –∏–º—è –∏–ª–∏ —Ñ–∞–º–∏–ª–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞:\n\n"
                "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å' –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞.",
                reply_markup=self.cancel_keyboard()
            )
            context.user_data['searching_user'] = True
            return USER_SEARCH

        search_query = ' '.join(context.args)
        await self.send_users_page(update, context, page=0, search_query=search_query)
        return ConversationHandler.END

    async def receive_user_search(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return ConversationHandler.END

        user_id = update.message.from_user.id
        search_query = update.message.text

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–º–µ–Ω—É
        if search_query == "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å":
            await update.message.reply_text(
                "‚ùå –ü–æ–∏—Å–∫ –æ—Ç–º–µ–Ω–µ–Ω.",
                reply_markup=self.main_keyboard(user_id)
            )
            context.user_data.pop('searching_user', None)
            return ConversationHandler.END

        await self.send_users_page(update, context, page=0, search_query=search_query)
        context.user_data.pop('searching_user', None)
        return ConversationHandler.END

    async def recent_users(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        days = 7
        if context.args:
            try:
                days = int(context.args[0])
            except ValueError:
                pass

        users = db.get_recent_users(days=days)

        if not users:
            await update.message.reply_text(f"‚ùå –ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {days} –¥–Ω–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
            return

        message = f"üÜï –ù–û–í–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {days} –¥–Ω–µ–π)\n\n"

        for i, user in enumerate(users, start=1):
            username = f"@{user['username']}" if user['username'] else "–±–µ–∑ username"
            full_name = f"{user['first_name'] or ''} {user['last_name'] or ''}".strip()
            created_date = user['created_at'].split()[0] if user['created_at'] else "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

            message += f"{i}. {full_name} ({username})\n"
            message += f"   üÜî: {user['user_id']}\n"
            message += f"   üìÖ: {created_date}\n\n"

        message += f"üìä –í—Å–µ–≥–æ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(users)}"

        await update.message.reply_text(message)

    async def user_info(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        if not context.args:
            await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /userinfo <user_id> –∏–ª–∏ /userinfo @username")
            return

        target = context.args[0]

        try:
            # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ ID
            target_id = int(target)
            user_info = db.get_user_by_id(target_id)
        except ValueError:
            # –ò—â–µ–º –ø–æ username
            user_info = db.get_user_by_username(target)

        if not user_info:
            await update.message.reply_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_stats = db.get_user_stats(user_info['user_id'])
        is_banned = db.is_user_banned(user_info['user_id'])
        is_admin = user_info['user_id'] in ADMIN_IDS
        is_moderator = user_info['user_id'] in MODERATOR_IDS

        message = "üë§ –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï\n\n"
        message += f"üÜî ID: {user_info['user_id']}\n"

        if user_info['username']:
            message += f"üì± Username: @{user_info['username']}\n"

        if user_info['first_name']:
            message += f"üë§ –ò–º—è: {user_info['first_name']}\n"

        if user_info['last_name']:
            message += f"üìõ –§–∞–º–∏–ª–∏—è: {user_info['last_name']}\n"

        message += f"üìÖ –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {user_info['created_at']}\n\n"

        message += "üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê:\n"
        message += f"   üìù –ó–∞—è–≤–æ–∫ –ø–æ–¥–∞–Ω–æ: {user_stats['applications_count']}\n"
        message += f"   ‚ùì –í–æ–ø—Ä–æ—Å–æ–≤ –∑–∞–¥–∞–Ω–æ: {user_stats['questions_count']}\n"
        message += f"   üí¨ –û—Ç–∑—ã–≤–æ–≤ –æ—Å—Ç–∞–≤–ª–µ–Ω–æ: {user_stats['feedback_count']}\n"

        if user_stats['last_activity']:
            message += f"   ‚è∞ –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {user_stats['last_activity']}\n"

        message += f"   üö´ –°—Ç–∞—Ç—É—Å: {'–ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù' if is_banned else '–ê–∫—Ç–∏–≤–µ–Ω'}\n"
        message += f"   üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: {'–î–∞' if is_admin else '–ù–µ—Ç'}\n"
        message += f"   üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä: {'–î–∞' if is_moderator else '–ù–µ—Ç'}\n"

        # –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        keyboard = []
        if not is_banned:
            keyboard.append([InlineKeyboardButton("üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"ban_user_{user_info['user_id']}")])
        else:
            keyboard.append(
                [InlineKeyboardButton("‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"unban_user_{user_info['user_id']}")])

        if not is_admin and user_id in ADMIN_IDS:
            keyboard.append(
                [InlineKeyboardButton("üëë –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º", callback_data=f"make_admin_{user_info['user_id']}")])

        if not is_moderator and user_id in ADMIN_IDS:
            keyboard.append([InlineKeyboardButton("üõ°Ô∏è –°–¥–µ–ª–∞—Ç—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º",
                                                  callback_data=f"make_moderator_{user_info['user_id']}")])

        keyboard.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_back")])

        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text(message, reply_markup=reply_markup)

    async def ping(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        start_time = datetime.now()
        message = await update.message.reply_text("üèì –ü–æ–Ω–≥...")
        end_time = datetime.now()
        ping_time = (end_time - start_time).total_seconds() * 1000

        await message.edit_text(f"üèì –ü–æ–Ω–≥! –ó–∞–¥–µ—Ä–∂–∫–∞: {ping_time:.2f} –º—Å")

    async def feedback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return ConversationHandler.END

        user_id = update.message.from_user.id

        if db.is_user_banned(user_id):
            await update.message.reply_text("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –±–æ—Ç–∞.")
            return ConversationHandler.END

        await update.message.reply_text(
            "üí¨ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤ –æ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞.\n"
            "–í—ã –º–æ–∂–µ—Ç–µ –æ—Ü–µ–Ω–∏—Ç—å –±–æ—Ç–∞ –æ—Ç 1 –¥–æ 5 –∑–≤–µ–∑–¥ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç.\n\n"
            "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '‚ùå –û—Ç–º–µ–Ω–∞' –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞.",
            reply_markup=self.feedback_keyboard()
        )
        return FEEDBACK

    async def receive_feedback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∏–¥–±–µ–∫–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return ConversationHandler.END

        user = update.message.from_user
        text = update.message.text

        if text == "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å":
            await update.message.reply_text(
                "‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∑—ã–≤–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.",
                reply_markup=self.main_keyboard(user.id)
            )
            return ConversationHandler.END

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–µ–π—Ç–∏–Ω–≥ –≤ context.user_data
        rating = context.user_data.get('feedback_rating')

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–¥–±–µ–∫
        db.add_feedback(user.id, text, rating)
        db.log_action(user.id, "feedback", f"–†–µ–π—Ç–∏–Ω–≥: {rating}, –¢–µ–∫—Å—Ç: {text[:50]}...")

        # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        context.user_data.pop('feedback_rating', None)
        context.user_data.pop('feedback_mode', None)

        thank_you_msg = "‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤! –ú—ã —Ü–µ–Ω–∏–º –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ –∏ —É—á—Ç–µ–º –µ–≥–æ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –±–æ—Ç–∞."
        if rating:
            thank_you_msg = f"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ü–µ–Ω–∫—É {rating}‚≠ê –∏ –æ—Ç–∑—ã–≤! –ú—ã —Ü–µ–Ω–∏–º –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ."

        await update.message.reply_text(
            thank_you_msg,
            reply_markup=self.main_keyboard(user.id)
        )

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤ –æ –Ω–æ–≤–æ–º —Ñ–∏–¥–±–µ–∫–µ
        rating_text = f"–†–µ–π—Ç–∏–Ω–≥: {rating}‚≠ê" if rating else "–¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç"
        for admin_id in ADMIN_IDS:
            try:
                await self.application.bot.send_message(
                    admin_id,
                    f"üí¨ –ù–æ–≤—ã–π –æ—Ç–∑—ã–≤ –æ—Ç @{user.username} ({rating_text}):\n\n{text}"
                )
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞ {admin_id}: {e}")

        return ConversationHandler.END

    async def bot_status(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–°—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id
        stats = db.get_stats()

        status_text = "ü§ñ –°–¢–ê–¢–£–° –ë–û–¢–ê\n\n"
        status_text += f"üü¢ –°—Ç–∞—Ç—É—Å: {'–í —Ä–∞–±–æ—Ç–µ' if not self.maintenance_mode else 'üî¥ –†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è'}\n"
        status_text += f"üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['total_users']}\n"
        status_text += f"üìù –ó–∞—è–≤–æ–∫ –≤—Å–µ–≥–æ: {stats['total_applications']}\n"
        status_text += f"‚ùì –í–æ–ø—Ä–æ—Å–æ–≤ –≤—Å–µ–≥–æ: {stats['total_questions']}\n"
        status_text += f"üí¨ –û—Ç–∑—ã–≤–æ–≤: {stats['total_feedback']}\n"

        if stats['avg_feedback_rating'] > 0:
            status_text += f"‚≠ê –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: {stats['avg_feedback_rating']}/5\n"

        status_text += f"\nüìä –ó–ê –°–ï–ì–û–î–ù–Ø:\n"
        status_text += f"   üë• –ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['new_users_today']}\n"
        status_text += f"   üìù –ù–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫: {stats['pending_applications']}\n"
        status_text += f"   ‚ùì –ù–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤: {stats['unanswered_questions']}\n\n"

        status_text += f"üìã –ß–ï–†–ù–´–ï –°–ü–ò–°–ö–ò:\n"
        status_text += f"   ‚ùå –ß–°–ö: {stats['blacklist_clan_count']} –∏–≥—Ä–æ–∫–æ–≤\n"
        status_text += f"   üö´ –ß–°–ö–ö: {stats['blacklist_staff_count']} –∏–≥—Ä–æ–∫–æ–≤"

        await update.message.reply_text(status_text)

    async def get_user_id(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–π ID"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user = update.message.from_user
        role = "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" if user.id in ADMIN_IDS else "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä" if user.id in MODERATOR_IDS else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
        await update.message.reply_text(
            f"üÜî –í–∞—à ID: `{user.id}`\n"
            f"üì± Username: @{user.username or '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}\n"
            f"üë§ –ò–º—è: {user.first_name or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\n"
            f"üìõ –§–∞–º–∏–ª–∏—è: {user.last_name or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n"
            f"üé≠ –†–æ–ª—å: {role}",
            parse_mode='Markdown'
        )

    async def maintenance_mode_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        if not context.args:
            status = "–≤–∫–ª—é—á–µ–Ω" if self.maintenance_mode else "–≤—ã–∫–ª—é—á–µ–Ω"
            await update.message.reply_text(f"üîß –†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è: {status}")
            return

        action = context.args[0].lower()
        if action in ["on", "–≤–∫–ª", "enable"]:
            self.maintenance_mode = True
            await update.message.reply_text("üî¥ –†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –í–ö–õ–Æ–ß–ï–ù. –ë–æ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
            db.log_action(user_id, "maintenance", "–†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω")
        elif action in ["off", "–≤—ã–∫–ª", "disable"]:
            self.maintenance_mode = False
            await update.message.reply_text("üü¢ –†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –í–´–ö–õ–Æ–ß–ï–ù. –ë–æ—Ç —Å–Ω–æ–≤–∞ –¥–æ—Å—Ç—É–ø–µ–Ω.")
            db.log_action(user_id, "maintenance", "–†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω")
        else:
            await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /maintenance on/off")

    async def show_feedback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        feedback_list = db.get_feedback(limit=20)

        if not feedback_list:
            await update.message.reply_text("üí¨ –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
            return

        message = "üí¨ –ü–û–°–õ–ï–î–ù–ò–ï –û–¢–ó–´–í–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô\n\n"

        for i, feedback in enumerate(feedback_list, 1):
            username = f"@{feedback['username']}" if feedback['username'] else "–±–µ–∑ username"
            full_name = f"{feedback['first_name'] or ''} {feedback['last_name'] or ''}".strip()
            rating = "‚≠ê" * feedback['rating'] if feedback['rating'] else "üìù –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç"
            date = feedback['created_at'].split()[0]

            message += f"{i}. {full_name} ({username})\n"
            message += f"   {rating}\n"
            message += f"   üí¨ {feedback['feedback_text'][:100]}{'...' if len(feedback['feedback_text']) > 100 else ''}\n"
            message += f"   üìÖ {date}\n\n"

        await update.message.reply_text(message)

    async def notify_user(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        if len(context.args) < 2:
            await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /notify @username —Ç–µ–∫—Å—Ç_—Å–æ–æ–±—â–µ–Ω–∏—è")
            return

        target_username = context.args[0]
        message_text = ' '.join(context.args[1:])

        user_info = db.get_user_by_username(target_username)
        if not user_info:
            await update.message.reply_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º username –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        try:
            await self.application.bot.send_message(
                user_info['user_id'],
                f"üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏:\n\n{message_text}"
            )
            await update.message.reply_text(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é @{target_username}")
            db.log_action(user_id, "notify_user", f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {target_username}, –°–æ–æ–±—â–µ–Ω–∏–µ: {message_text[:50]}...")
        except Exception as e:
            await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")

    async def backup_database(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–°–æ–∑–¥–∞—Ç—å backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        try:
            # –°–æ–∑–¥–∞–µ–º backup
            backup_filename = f"backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.db"
            shutil.copy2("bot_database.db", backup_filename)

            await update.message.reply_text(f"‚úÖ Backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω: `{backup_filename}`", parse_mode='Markdown')
            db.log_action(user_id, "backup", f"–§–∞–π–ª: {backup_filename}")
        except Exception as e:
            await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è backup: {e}")

    async def export_data(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ CSV"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        try:
            # –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            users = db.get_all_users(limit=1000)  # –ë–æ–ª—å—à–æ–π –ª–∏–º–∏—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
            if users:
                output = io.StringIO()
                writer = csv.writer(output)
                writer.writerow(['ID', 'Username', 'First Name', 'Last Name', 'Created At'])
                for user in users:
                    writer.writerow([
                        user['user_id'],
                        user['username'] or '',
                        user['first_name'] or '',
                        user['last_name'] or '',
                        user['created_at']
                    ])

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
                bio = io.BytesIO(output.getvalue().encode('utf-8'))
                bio.name = f"users_export_{datetime.now().strftime('%Y%m%d')}.csv"
                await update.message.reply_document(bio, caption="üìä –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")

            db.log_action(user_id, "export_data", "CSV —ç–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
        except Exception as e:
            await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö: {e}")

    async def cleanup_data(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        days = 30
        if context.args:
            try:
                days = int(context.args[0])
            except ValueError:
                pass

        result = db.clear_old_data(days=days)

        message = f"üßπ –û–ß–ò–°–¢–ö–ê –î–ê–ù–ù–´–• (—Å—Ç–∞—Ä—à–µ {days} –¥–Ω–µ–π)\n\n"
        message += f"üìù –£–¥–∞–ª–µ–Ω–æ –∑–∞—è–≤–æ–∫: {result['deleted_applications'] or 0}\n"
        message += f"‚ùì –£–¥–∞–ª–µ–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {result['deleted_questions'] or 0}\n"
        message += f"üìã –£–¥–∞–ª–µ–Ω–æ –ª–æ–≥–æ–≤: {result['deleted_logs'] or 0}"

        await update.message.reply_text(message)
        db.log_action(user_id, "cleanup_data", f"–î–Ω–µ–π: {days}")

    async def show_logs(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        logs = db.get_action_logs(limit=20)

        if not logs:
            await update.message.reply_text("üìù –õ–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.")
            return

        message = "üìù –ü–û–°–õ–ï–î–ù–ò–ï –î–ï–ô–°–¢–í–ò–Ø\n\n"

        for log in logs:
            username = f"@{log['username']}" if log['username'] else f"ID:{log['user_id']}"
            time = log['created_at'].split()[1][:5]  # —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è
            message += f"üïí {time} | {username} | {log['action']}"
            if log['details']:
                message += f" | {log['details'][:30]}..."
            message += "\n"

        await update.message.reply_text(message)

    async def broadcast(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return ConversationHandler.END

        user_id = update.message.from_user.id

        if user_id not in ADMIN_IDS:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return ConversationHandler.END

        if not context.args:
            await update.message.reply_text(
                "üì¢ –í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:\n\n"
                "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å' –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞.",
                reply_markup=self.cancel_keyboard()
            )
            return BROADCAST

        message_text = ' '.join(context.args)
        await self.send_broadcast(update, context, message_text)
        return ConversationHandler.END

    async def receive_broadcast(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return ConversationHandler.END

        user_id = update.message.from_user.id
        text = update.message.text

        if text == "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å":
            await update.message.reply_text(
                "‚ùå –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.",
                reply_markup=self.main_keyboard(user_id)
            )
            return ConversationHandler.END

        await self.send_broadcast(update, context, text)
        return ConversationHandler.END

    async def send_broadcast(self, update: Update, context: ContextTypes.DEFAULT_TYPE, message_text: str):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏"""
        users = db.get_all_users()
        success_count = 0
        fail_count = 0

        progress_msg = await update.message.reply_text(f"üì¢ –†–∞—Å—Å—ã–ª–∫–∞ –Ω–∞—á–∞—Ç–∞... 0/{len(users)}")

        for i, user in enumerate(users):
            try:
                await self.application.bot.send_message(
                    user['user_id'],
                    f"üì¢ –û–ë–™–Ø–í–õ–ï–ù–ò–ï –û–¢ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–ò:\n\n{message_text}"
                )
                success_count += 1

                # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
                if i % 10 == 0:
                    await progress_msg.edit_text(f"üì¢ –†–∞—Å—Å—ã–ª–∫–∞... {i}/{len(users)}")

                # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã Telegram
                await asyncio.sleep(0.1)

            except Exception as e:
                fail_count += 1
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user['user_id']}: {e}")

        await progress_msg.edit_text(
            f"‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n"
            f"‚úÖ –£—Å–ø–µ—à–Ω–æ: {success_count}\n"
            f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å: {fail_count}"
        )

        db.log_action(update.message.from_user.id, "broadcast",
                      f"–°–æ–æ–±—â–µ–Ω–∏–µ: {message_text[:50]}..., –£—Å–ø–µ—à–Ω–æ: {success_count}")

    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return

        user_id = update.message.from_user.id

        help_text = "ü§ñ –°–ü–†–ê–í–ö–ê –ü–û –ö–û–ú–ê–ù–î–ê–ú –ë–û–¢–ê\n\n"

        # –û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã
        help_text += "üîÑ –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´:\n"
        help_text += "/start - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞\n"
        help_text += "/menu - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
        help_text += "/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n"
        help_text += "/rules - –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –∫–ª–∞–Ω–∞\n"
        help_text += "/ping - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –±–æ—Ç–∞\n"
        help_text += "/status - –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
        help_text += "/id - –ü–æ–∫–∞–∑–∞—Ç—å –≤–∞—à ID\n"
        help_text += "/feedback - –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –æ –±–æ—Ç–µ\n\n"

        # –ö–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
        if user_id in ADMIN_IDS:
            help_text += "üëë –ö–û–ú–ê–ù–î–´ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê:\n"
            help_text += "/admin - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n"
            help_text += "/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞\n"
            help_text += "/admins - –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤\n"
            help_text += "/moderators - –°–ø–∏—Å–æ–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤\n"
            help_text += "/users - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n"
            help_text += "/finduser - –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n"
            help_text += "/recentusers - –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏\n"
            help_text += "/userinfo - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ\n"
            help_text += "/ban - –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n"
            help_text += "/unban - –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n"
            help_text += "/banned - –°–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö\n"
            help_text += "/addadmin - –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n"
            help_text += "/removeadmin - –£–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n"
            help_text += "/addmoderator - –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞\n"
            help_text += "/removemoderator - –£–¥–∞–ª–∏—Ç—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞\n"
            help_text += "/blacklist - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–Ω—ã–º–∏ —Å–ø–∏—Å–∫–∞–º–∏\n"
            help_text += "/broadcast - –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π\n"
            help_text += "/notify - –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n"
            help_text += "/logs - –õ–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π\n"
            help_text += "/feedback_list - –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤\n"
            help_text += "/maintenance - –†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è\n"
            help_text += "/cleanup - –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö\n"
            help_text += "/export - –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö\n"
            help_text += "/backup - Backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\n\n"

        # –ö–æ–º–∞–Ω–¥—ã –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
        if user_id in MODERATOR_IDS:
            help_text += "üõ°Ô∏è –ö–û–ú–ê–ù–î–´ –ú–û–î–ï–†–ê–¢–û–†–ê:\n"
            help_text += "/moderator - –ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞\n"
            help_text += "/blacklist - –ü—Ä–æ—Å–º–æ—Ç—Ä —á–µ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤\n"

        await update.message.reply_text(help_text)

    async def question(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return ConversationHandler.END

        user = update.message.from_user

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if db.is_user_banned(user.id):
            await update.message.reply_text("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –±–æ—Ç–∞.")
            return ConversationHandler.END

        await update.message.reply_text(
            "–ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∞–Ω–∞ –æ—Ç–≤–µ—Ç–∏—Ç –≤–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è:\n\n"
            "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å' –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
            reply_markup=self.cancel_keyboard()
        )
        return QUESTION

    async def receive_question(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return ConversationHandler.END

        user = update.message.from_user
        text = update.message.text

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if db.is_user_banned(user.id):
            await update.message.reply_text("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –±–æ—Ç–∞.")
            return ConversationHandler.END

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–º–µ–Ω—É
        if text == "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å":
            await update.message.reply_text(
                "‚ùå –°–æ–∑–¥–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
                reply_markup=self.main_keyboard(user.id)
            )
            return ConversationHandler.END

        db.add_question(user.id, text)
        db.log_action(user.id, "ask_question", f"–í–æ–ø—Ä–æ—Å: {text[:50]}...")

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await update.message.reply_text(
            "‚úÖ –í–∞—à –≤–æ–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏. –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞!",
            reply_markup=self.main_keyboard(user.id)
        )

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤
        for admin_id in ADMIN_IDS:
            try:
                await self.application.bot.send_message(
                    admin_id,
                    f"‚ùì –ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –æ—Ç @{user.username}:\n\n{text}"
                )
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞ {admin_id}: {e}")

        return ConversationHandler.END

    async def moderation(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return ConversationHandler.END

        user = update.message.from_user

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if db.is_user_banned(user.id):
            await update.message.reply_text("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –±–æ—Ç–∞.")
            return ConversationHandler.END

        await update.message.reply_text(
            "üìù –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É –¥–ª—è –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏ –≤ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã:\n\n"
            "‚ÄºÔ∏èüá∑üá∫–ü—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–±–ª—é–¥–∞—Ç—å –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞.üá∑üá∫‚ÄºÔ∏è\n"
            "1Ô∏è‚É£. –í–∞—à –Ω–∏–∫:  \n"
            "2Ô∏è‚É£. –í–∞—à –≤–æ–∑—Ä–∞—Å—Ç:\n"
            "3Ô∏è‚É£. –í—ã–¥–∞–≤–∞–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∏–≥—Ä–æ–∫–∞–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ?:\n"
            "4Ô∏è‚É£. –î–∞–π—Ç–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–≤–∞–º –ë–∞–Ω/–ú—É—Ç/–í–∞—Ä–Ω:\n"
            "5Ô∏è‚É£. –ï—Å—Ç—å –æ–ø—ã—Ç –º–æ–¥–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è?:\n"
            "6Ô∏è‚É£. –ù–∞–ø–∏—à–∏—Ç–µ –Ω–µ–±–æ–ª—å—à–æ–π —Ä–∞—Å—Å–∫–∞–∑ –æ —Å–µ–±–µ(–Ω–µ –º–µ–Ω–µ–µ –¥–≤–∞–¥—Ü–∞—Ç–∏ —Å–ª–æ–≤)\n"
            "7Ô∏è‚É£. –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –í—ã, –≥–æ—Ç–æ–≤—ã —É–¥–µ–ª—è—Ç—å –Ω–∞–±–æ—Ä—É –≤ –∫–ª–∞–Ω?\n"
            "8Ô∏è‚É£. –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ –Ω–∞—à –∫–ª–∞–Ω?\n"
            "9Ô∏è‚É£.–ö—Ç–æ –≤–∞—Å –ø—Ä–∏–≥–ª–∞—Å–∏–ª –Ω–∞ —Å—Ç–∞–∂—ë—Ä–∞? (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –µ—Å–ª–∏ —É–∑–Ω–∞–ª–∏ —Å–∞–º–∏)\n\n"
            "                ‚ÄºÔ∏è–í–∞–∂–Ω–æ‚ÄºÔ∏è\n"
            "‚ÄºÔ∏è–ï—Å–ª–∏ –≤–∞—à—É –∑–∞—è–≤–∫—É –æ–¥–æ–±—Ä—è—é—Ç, —Ç–æ –≤—ã —Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å –Ω–∞ –ø–æ—Å—Ç ‚úÖ—Å—Ç–∞–∂—ë—Ä–∞‚úÖ –∫–ª–∞–Ω–∞.‚ÄºÔ∏è\n"
            "‚öôÔ∏è–ù–∞ —Å—Ç–∞–∂—ë—Ä–∫–µ –Ω–µ–ª—å–∑—è –±—Ä–∞—Ç—å –æ—Ç–≥—É–ª—ã.‚öôÔ∏è\n"
            "‚ÄºÔ∏è–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–µ -  7 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –≤—ã–¥–∞—á–∏ —Ä–æ–ª–∏ .‚ÄºÔ∏è\n"
            "‚ùå–ü–æ–ª—É—á–µ–Ω–∏–µ 1 –≤—ã–≥–æ–≤–æ—Ä–∞ –Ω–∞ —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–µ - —Å–Ω—è—Ç–∏–µ‚ùå\n\n\n"
            "‚öôÔ∏è–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ –º–æ–∂–µ—Ç —É–π—Ç–∏ –æ—Ç 1Ô∏è‚É£ –¥–æ 2Ô∏è‚É£ –¥–Ω–µ–π‚öôÔ∏è\n\n"
            "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.\n"
            "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å' –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
            reply_markup=self.cancel_keyboard()
        )
        return MODERATION

    async def receive_moderation(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return ConversationHandler.END

        user = update.message.from_user
        text = update.message.text

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if db.is_user_banned(user.id):
            await update.message.reply_text("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –±–æ—Ç–∞.")
            return ConversationHandler.END

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–º–µ–Ω—É
        if text == "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å":
            await update.message.reply_text(
                "‚ùå –ü–æ–¥–∞—á–∞ –∑–∞—è–≤–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞.",
                reply_markup=self.main_keyboard(user.id)
            )
            return ConversationHandler.END

        db.add_application(user.id, text)
        db.log_action(user.id, "submit_application", f"–ó–∞—è–≤–∫–∞: {text[:50]}...")

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await update.message.reply_text(
            "‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ! "
            "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.",
            reply_markup=self.main_keyboard(user.id)
        )

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤
        for admin_id in ADMIN_IDS:
            try:
                await self.application.bot.send_message(
                    admin_id,
                    f"üìù –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –≤ –º–æ–¥–µ—Ä–∞—Ü–∏—é –æ—Ç @{user.username}:\n\n{text}"
                )
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞ {admin_id}: {e}")

        return ConversationHandler.END

    async def cancel(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if not await self.check_private_chat(update):
            return ConversationHandler.END

        user_id = update.message.from_user.id
        await update.message.reply_text(
            "–î–∏–∞–ª–æ–≥ –æ—Ç–º–µ–Ω–µ–Ω.",
            reply_markup=self.main_keyboard(user_id)
        )
        return ConversationHandler.END

    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_id = update.message.from_user.id
        text = update.message.text

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
        if self.maintenance_mode and user_id not in ADMIN_IDS:
            await update.message.reply_text(
                "üî¥ –ë–æ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è. "
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )
            return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if db.is_user_banned(user_id):
            await update.message.reply_text("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –±–æ—Ç–∞.")
            return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if update.effective_chat.type != "private":
            # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –õ–°, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è —á—Ç–æ-—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            return

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å
        if 'answering_question' in context.user_data:
            question_id = context.user_data.pop('answering_question')
            question = db.get_question(question_id)

            try:
                await self.application.bot.send_message(
                    question['user_id'],
                    f"üí¨ –û—Ç–≤–µ—Ç –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å:\n\n{text}"
                )
                db.update_question_status(question_id, "answered", user_id)
                db.log_action(user_id, "answer_question", f"–í–æ–ø—Ä–æ—Å #{question_id}")
                await update.message.reply_text("‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.",
                                                reply_markup=self.main_keyboard(user_id))
            except Exception as e:
                await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞.", reply_markup=self.main_keyboard(user_id))
            return

        # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        if text == "‚ùì –í–æ–ø—Ä–æ—Å":
            return await self.question(update, context)
        elif text == "üìù –ù–∞–±–æ—Ä –≤ –º–æ–¥–µ—Ä–∞—Ü–∏—é":
            return await self.moderation(update, context)
        elif text == "üìú –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞–Ω–µ":
            await self.show_rules(update, context)
        elif text == "üëë –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞" and user_id in ADMIN_IDS:
            await self.admin_panel(update, context)
        elif text == "üõ°Ô∏è –ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞" and (user_id in MODERATOR_IDS or user_id in ADMIN_IDS):
            await self.moderator_panel(update, context)
        elif text == "üí¨ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å":
            return await self.feedback(update, context)
        elif text == "‚ÑπÔ∏è –û –±–æ—Ç–µ":
            await self.bot_status(update, context)
        else:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤ –¥–∏–∞–ª–æ–≥–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –ß–°
            if context.user_data.get('awaiting_blacklist_add'):
                return await self.receive_blacklist_add(update, context)
            elif context.user_data.get('awaiting_blacklist_remove'):
                return await self.receive_blacklist_remove(update, context)
            elif context.user_data.get('awaiting_blacklist_search'):
                return await self.receive_blacklist_search(update, context)
            else:
                await update.message.reply_text(
                    "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:",
                    reply_markup=self.main_keyboard(user_id)
                )

    async def button_handler(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        query = update.callback_query
        await query.answer()

        user_id = query.from_user.id

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if self.maintenance_mode and user_id not in ADMIN_IDS:
            await query.edit_message_text(
                "üî¥ –ë–æ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è. "
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )
            return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ callback –ø—Ä–∏—à–µ–ª –∏–∑ –ª–∏—á–Ω–æ–≥–æ —á–∞—Ç–∞
        if query.message.chat.type != "private":
            await query.edit_message_text("‚ùå –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.")
            return

        if query.data == "admin_back" or query.data == "mod_back":
            await query.edit_message_text(
                "–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
                reply_markup=None
            )
            await query.message.reply_text(
                "–ü–∞–Ω–µ–ª—å –∑–∞–∫—Ä—ã—Ç–∞.",
                reply_markup=self.main_keyboard(user_id)
            )
            return

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–ª—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥
        if user_id not in ADMIN_IDS and not query.data.startswith(("feedback_", "mod_", "bl_view_")):
            await query.edit_message_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return

        data = query.data

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∏–¥–±–µ–∫–∞
        if data.startswith("feedback_"):
            if data == "feedback_cancel":
                await query.edit_message_text(
                    "‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∑—ã–≤–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.",
                    reply_markup=self.main_keyboard(user_id)
                )
                return

            elif data == "feedback_text":
                await query.edit_message_text(
                    "üí¨ –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–∑—ã–≤:\n\n"
                    "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å' –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞.",
                    reply_markup=self.cancel_keyboard()
                )
                context.user_data['feedback_mode'] = True
                return FEEDBACK

            else:
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞
                rating = int(data.split('_')[1])
                await query.edit_message_text(
                    f"‚≠ê –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ü–µ–Ω–∫—É {rating}/5!\n"
                    f"–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç—å –µ—ë —Ç–µ–∫—Å—Ç–æ–≤—ã–º –æ—Ç–∑—ã–≤–æ–º:\n\n"
                    f"–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å' –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞.",
                    reply_markup=self.cancel_keyboard()
                )
                context.user_data['feedback_rating'] = rating
                context.user_data['feedback_mode'] = True
                return FEEDBACK

        # –ê–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
        if data == "admin_applications":
            await self.show_applications(query, context)
        elif data == "admin_questions":
            await self.show_questions(query, context)
        elif data == "admin_stats":
            await self.show_stats(query, context)
        elif data == "admin_banned":
            await self.show_banned_users_callback(query, context)
        elif data == "admin_users":
            await self.send_users_page(query, context, page=0)
        elif data == "admin_search_user":
            await query.edit_message_text(
                "üîç –í–≤–µ–¥–∏—Ç–µ username, –∏–º—è –∏–ª–∏ —Ñ–∞–º–∏–ª–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞:",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_back")]
                ])
            )
            context.user_data['searching_user'] = True
            return USER_SEARCH
        elif data == "admin_recent_users":
            await self.recent_users_callback(query, context)
        elif data == "admin_feedback":
            await self.show_feedback_callback(query, context)
        elif data == "admin_logs":
            await self.show_logs_callback(query, context)
        elif data == "admin_settings":
            await self.show_settings(query, context)
        elif data == "admin_blacklist_menu":
            await self.show_blacklist_menu_callback(query, context)
        elif data == "admin_moderators":
            await self.show_moderators_callback(query, context)
        elif data == "toggle_maintenance":
            self.maintenance_mode = not self.maintenance_mode
            status = "–≤–∫–ª—é—á–µ–Ω" if self.maintenance_mode else "–≤—ã–∫–ª—é—á–µ–Ω"
            db.log_action(user_id, "toggle_maintenance", f"–†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è: {status}")
            await self.show_settings(query, context)
        elif data == "export_data":
            await self.export_data_callback(query, context)
        elif data == "cleanup_data":
            await self.cleanup_data_callback(query, context)
        elif data == "backup_db":
            await self.backup_database_callback(query, context)

        # –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
        elif data.startswith("mod_"):
            if user_id not in MODERATOR_IDS and user_id not in ADMIN_IDS:
                await query.edit_message_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞.")
                return

            if data == "mod_view_clan":
                await self.view_blacklist(query, context, BLACKLIST_CLAN)
            elif data == "mod_view_staff":
                await self.view_blacklist(query, context, BLACKLIST_STAFF)
            elif data == "mod_search_blacklist":
                await query.edit_message_text(
                    "üîç –í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ —á–µ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∫–∞—Ö:",
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="mod_back")]
                    ])
                )
                context.user_data['awaiting_blacklist_search'] = True
                return BLACKLIST_SEARCH
            elif data == "mod_blacklist_stats":
                await self.show_blacklist_stats(query, context)

        # –ö–æ–º–∞–Ω–¥—ã —á–µ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤
        elif data.startswith("bl_"):
            if data == "bl_add_clan":
                context.user_data['blacklist_type'] = BLACKLIST_CLAN
                context.user_data['awaiting_blacklist_add'] = True
                await query.edit_message_text(
                    f"‚ûï –í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –∏–≥—Ä–æ–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ {BLACKLIST_CLAN}:\n\n"
                    f"–§–æ—Ä–º–∞—Ç: –Ω–∏–∫–Ω–µ–π–º –ø—Ä–∏—á–∏–Ω–∞ (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∏–∫–Ω–µ–π–º)",
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_blacklist_menu")]
                    ])
                )
                return ADD_TO_BLACKLIST
            elif data == "bl_add_staff":
                context.user_data['blacklist_type'] = BLACKLIST_STAFF
                context.user_data['awaiting_blacklist_add'] = True
                await query.edit_message_text(
                    f"‚ûï –í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –∏–≥—Ä–æ–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ {BLACKLIST_STAFF}:\n\n"
                    f"–§–æ—Ä–º–∞—Ç: –Ω–∏–∫–Ω–µ–π–º –ø—Ä–∏—á–∏–Ω–∞ (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∏–∫–Ω–µ–π–º)",
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_blacklist_menu")]
                    ])
                )
                return ADD_TO_BLACKLIST
            elif data == "bl_remove_clan":
                context.user_data['blacklist_type'] = BLACKLIST_CLAN
                context.user_data['awaiting_blacklist_remove'] = True
                await query.edit_message_text(
                    f"‚ûñ –í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –∏–≥—Ä–æ–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ {BLACKLIST_CLAN}:",
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_blacklist_menu")]
                    ])
                )
                return REMOVE_FROM_BLACKLIST
            elif data == "bl_remove_staff":
                context.user_data['blacklist_type'] = BLACKLIST_STAFF
                context.user_data['awaiting_blacklist_remove'] = True
                await query.edit_message_text(
                    f"‚ûñ –í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –∏–≥—Ä–æ–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ {BLACKLIST_STAFF}:",
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_blacklist_menu")]
                    ])
                )
                return REMOVE_FROM_BLACKLIST
            elif data == "bl_view_clan":
                await self.view_blacklist(query, context, BLACKLIST_CLAN)
            elif data == "bl_view_staff":
                await self.view_blacklist(query, context, BLACKLIST_STAFF)
            elif data == "bl_search":
                await query.edit_message_text(
                    "üîç –í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ —á–µ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∫–∞—Ö:",
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_blacklist_menu")]
                    ])
                )
                context.user_data['awaiting_blacklist_search'] = True
                return BLACKLIST_SEARCH
            elif data == "bl_stats":
                await self.show_blacklist_stats(query, context)
            elif data.startswith("bl_page_"):
                parts = data.split('_')
                list_type = parts[2]
                page = int(parts[3])
                await self.view_blacklist(query, context, list_type, page)

        # –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        elif data.startswith("users_page_"):
            parts = query.data.split('_')
            page = int(parts[2])
            search_query = parts[3] if len(parts) > 3 and parts[3] else None
            await self.send_users_page(query, context, page=page, search_query=search_query)

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—è–≤–æ–∫ –∏ –≤–æ–ø—Ä–æ—Å–æ–≤
        elif data.startswith("app_"):
            await self.handle_application_action(query, data, context)
        elif data.startswith("question_"):
            await self.handle_question_action(query, data, context)

        # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏
        elif data.startswith("make_admin_"):
            target_id = int(data.split('_')[2])
            if target_id not in ADMIN_IDS:
                ADMIN_IDS.append(target_id)
                await query.edit_message_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_id} –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.")
                db.log_action(user_id, "make_admin", f"–ù–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω: {target_id}")
            else:
                await query.edit_message_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.")

        elif data.startswith("make_moderator_"):
            target_id = int(data.split('_')[2])
            if target_id not in MODERATOR_IDS:
                MODERATOR_IDS.append(target_id)
                await query.edit_message_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_id} –Ω–∞–∑–Ω–∞—á–µ–Ω –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º.")
                db.log_action(user_id, "make_moderator", f"–ù–∞–∑–Ω–∞—á–µ–Ω –º–æ–¥–µ—Ä–∞—Ç–æ—Ä: {target_id}")
            else:
                await query.edit_message_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä.")

        elif data.startswith("ban_user_"):
            target_id = int(data.split('_')[2])
            await query.edit_message_text(f"üö´ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /ban –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

        elif data.startswith("unban_user_"):
            target_id = int(data.split('_')[2])
            await query.edit_message_text(f"‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /unban –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

        else:
            await query.edit_message_text(
                "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
                reply_markup=self.admin_keyboard()
            )

    # --- –ú–ï–¢–û–î–´ –î–õ–Ø –ß–ï–†–ù–´–• –°–ü–ò–°–ö–û–í (–ù–ò–ö–ò –ë–ï–ó @) ---
    async def receive_blacklist_add(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if update.effective_chat.type != "private":
            return ConversationHandler.END

        user_id = update.message.from_user.id
        text = update.message.text

        if text == "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å":
            await update.message.reply_text(
                "‚ùå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
                reply_markup=self.main_keyboard(user_id)
            )
            context.user_data.pop('awaiting_blacklist_add', None)
            context.user_data.pop('blacklist_type', None)
            return ConversationHandler.END

        list_type = context.user_data.get('blacklist_type')
        if not list_type:
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω —Ç–∏–ø —Å–ø–∏—Å–∫–∞.")
            context.user_data.pop('awaiting_blacklist_add', None)
            return ConversationHandler.END

        # –†–∞–∑–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –Ω–∏–∫–Ω–µ–π–º –∏ –ø—Ä–∏—á–∏–Ω—É
        parts = text.split(' ', 1)
        username = parts[0].strip().lower()
        reason = parts[1] if len(parts) > 1 else f"–î–æ–±–∞–≤–ª–µ–Ω –≤ {list_type}"

        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –±–∞–∑—É
        if db.add_to_blacklist(username, list_type, reason, user_id):
            # –û–¢–í–ï–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ (–ù–ò–ö –ë–ï–ó @)
            await update.message.reply_text(
                f"‚úÖ –ò–≥—Ä–æ–∫ {username} –¥–æ–±–∞–≤–ª–µ–Ω –≤ {list_type}\n"
                f"üìù –ü—Ä–∏—á–∏–Ω–∞: {reason}",
                reply_markup=self.main_keyboard(user_id)
            )
            db.log_action(user_id, "add_to_blacklist", f"{list_type}: {username}")

            # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            admin_name = self.format_admin_name(user_id)

            # –§–û–†–ú–ò–†–£–ï–ú –¢–ï–ö–°–¢ –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (–ù–ò–ö –ë–ï–ó @)
            log_message = (
                f"‚ûï **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫**\n"
                f"‚Ä¢ **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:** {admin_name}\n"
                f"‚Ä¢ **–°–ø–∏—Å–æ–∫:** {list_type}\n"
                f"‚Ä¢ **–ò–≥—Ä–æ–∫:** {username}\n"
                f"‚Ä¢ **–ü—Ä–∏—á–∏–Ω–∞:** {reason}"
            )

            # --- 1. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –õ–° –≤—Å–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º ---
            failed_admins = []
            for admin_id in ADMIN_IDS:
                if admin_id != user_id:
                    try:
                        await self.application.bot.send_message(
                            admin_id,
                            log_message,
                            parse_mode='Markdown'
                        )
                    except Exception as e:
                        failed_admins.append(str(admin_id))
                        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É {admin_id}: {e}")

            if failed_admins:
                await update.message.reply_text(
                    f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º: {', '.join(failed_admins)}.\n"
                    f"–í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –±–æ—Ç–∞ –∏–ª–∏ –Ω–µ –ø–∏—Å–∞–ª–∏ –µ–º—É –≤ –õ–°."
                )

            # --- 2. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç –¥–ª—è –ª–æ–≥–æ–≤ ---
            if LOG_CHAT_ID:
                try:
                    if LOG_TOPIC_ID:
                        await self.application.bot.send_message(
                            chat_id=LOG_CHAT_ID,
                            text=log_message,
                            message_thread_id=LOG_TOPIC_ID,
                            parse_mode='Markdown'
                        )
                    else:
                        await self.application.bot.send_message(
                            LOG_CHAT_ID,
                            log_message,
                            parse_mode='Markdown'
                        )
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –ª–æ–≥-—á–∞—Ç {LOG_CHAT_ID}: {e}")
                    error_text = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç."
                    if "message thread not found" in str(e).lower():
                        error_text = f"‚ö†Ô∏è –û—à–∏–±–∫–∞: —Ç–µ–º–∞ —Å ID {LOG_TOPIC_ID} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å ID —Ç–µ–º—ã."
                    elif "chat not found" in str(e).lower():
                        error_text = "‚ö†Ô∏è –û—à–∏–±–∫–∞: —á–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –±–æ—Ç–∞ –≤ —á–∞—Ç–µ."
                    elif "forbidden" in str(e).lower():
                        error_text = "‚ö†Ô∏è –û—à–∏–±–∫–∞: –±–æ—Ç –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —ç—Ç–æ—Ç —á–∞—Ç. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É."

                    await update.message.reply_text(error_text)
        else:
            await update.message.reply_text(
                f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ {list_type}. –í–æ–∑–º–æ–∂–Ω–æ, –∏–≥—Ä–æ–∫ —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ.",
                reply_markup=self.main_keyboard(user_id)
            )

        context.user_data.pop('awaiting_blacklist_add', None)
        context.user_data.pop('blacklist_type', None)
        return ConversationHandler.END

    async def receive_blacklist_remove(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if update.effective_chat.type != "private":
            return ConversationHandler.END

        user_id = update.message.from_user.id
        text = update.message.text

        if text == "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å":
            await update.message.reply_text(
                "‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
                reply_markup=self.main_keyboard(user_id)
            )
            context.user_data.pop('awaiting_blacklist_remove', None)
            context.user_data.pop('blacklist_type', None)
            return ConversationHandler.END

        list_type = context.user_data.get('blacklist_type')
        if not list_type:
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω —Ç–∏–ø —Å–ø–∏—Å–∫–∞.")
            context.user_data.pop('awaiting_blacklist_remove', None)
            return ConversationHandler.END

        username = text.strip().lower()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Å–ø–∏—Å–∫–µ
        if not db.check_in_blacklist(username, list_type):
            await update.message.reply_text(
                f"‚ùå –ò–≥—Ä–æ–∫ {username} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ {list_type}",
                reply_markup=self.main_keyboard(user_id)
            )
            context.user_data.pop('awaiting_blacklist_remove', None)
            context.user_data.pop('blacklist_type', None)
            return ConversationHandler.END

        # –£–¥–∞–ª—è–µ–º –∏–∑ –±–∞–∑—ã
        if db.remove_from_blacklist(username, list_type):
            # –û–¢–í–ï–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ (–ù–ò–ö –ë–ï–ó @)
            await update.message.reply_text(
                f"‚úÖ –ò–≥—Ä–æ–∫ {username} —É–¥–∞–ª–µ–Ω –∏–∑ {list_type}",
                reply_markup=self.main_keyboard(user_id)
            )
            db.log_action(user_id, "remove_from_blacklist", f"{list_type}: {username}")

            # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            admin_name = self.format_admin_name(user_id)

            # –§–û–†–ú–ò–†–£–ï–ú –¢–ï–ö–°–¢ –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (–ù–ò–ö –ë–ï–ó @)
            log_message = (
                f"‚ûñ **–£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞**\n"
                f"‚Ä¢ **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:** {admin_name}\n"
                f"‚Ä¢ **–°–ø–∏—Å–æ–∫:** {list_type}\n"
                f"‚Ä¢ **–ò–≥—Ä–æ–∫:** {username}"
            )

            # --- 1. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –õ–° –≤—Å–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º ---
            failed_admins = []
            for admin_id in ADMIN_IDS:
                if admin_id != user_id:
                    try:
                        await self.application.bot.send_message(
                            admin_id,
                            log_message,
                            parse_mode='Markdown'
                        )
                    except Exception as e:
                        failed_admins.append(str(admin_id))
                        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É {admin_id}: {e}")

            if failed_admins:
                await update.message.reply_text(
                    f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º: {', '.join(failed_admins)}.\n"
                    f"–í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –±–æ—Ç–∞ –∏–ª–∏ –Ω–µ –ø–∏—Å–∞–ª–∏ –µ–º—É –≤ –õ–°."
                )

            # --- 2. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç –¥–ª—è –ª–æ–≥–æ–≤ ---
            if LOG_CHAT_ID:
                try:
                    if LOG_TOPIC_ID:
                        await self.application.bot.send_message(
                            chat_id=LOG_CHAT_ID,
                            text=log_message,
                            message_thread_id=LOG_TOPIC_ID,
                            parse_mode='Markdown'
                        )
                    else:
                        await self.application.bot.send_message(
                            LOG_CHAT_ID,
                            log_message,
                            parse_mode='Markdown'
                        )
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –ª–æ–≥-—á–∞—Ç {LOG_CHAT_ID}: {e}")
                    error_text = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç."
                    if "message thread not found" in str(e).lower():
                        error_text = f"‚ö†Ô∏è –û—à–∏–±–∫–∞: —Ç–µ–º–∞ —Å ID {LOG_TOPIC_ID} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å ID —Ç–µ–º—ã."
                    elif "chat not found" in str(e).lower():
                        error_text = "‚ö†Ô∏è –û—à–∏–±–∫–∞: —á–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –±–æ—Ç–∞ –≤ —á–∞—Ç–µ."
                    elif "forbidden" in str(e).lower():
                        error_text = "‚ö†Ô∏è –û—à–∏–±–∫–∞: –±–æ—Ç –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —ç—Ç–æ—Ç —á–∞—Ç. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É."

                    await update.message.reply_text(error_text)
        else:
            await update.message.reply_text(
                f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ {list_type}",
                reply_markup=self.main_keyboard(user_id)
            )

        context.user_data.pop('awaiting_blacklist_remove', None)
        context.user_data.pop('blacklist_type', None)
        return ConversationHandler.END

    async def receive_blacklist_search(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –≤—ã–∑–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
        if update.effective_chat.type != "private":
            return ConversationHandler.END

        user_id = update.message.from_user.id
        search_term = update.message.text

        if search_term == "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å":
            await update.message.reply_text(
                "‚ùå –ü–æ–∏—Å–∫ –æ—Ç–º–µ–Ω–µ–Ω.",
                reply_markup=self.main_keyboard(user_id)
            )
            context.user_data.pop('awaiting_blacklist_search', None)
            return ConversationHandler.END

        # –ò—â–µ–º –≤ –æ–±–æ–∏—Ö —Å–ø–∏—Å–∫–∞—Ö
        clan_results = db.search_in_blacklist(search_term, BLACKLIST_CLAN)
        staff_results = db.search_in_blacklist(search_term, BLACKLIST_STAFF)

        message = f"üîç –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–ò–°–ö–ê: '{search_term}'\n\n"

        if clan_results:
            message += f"‚ùå –ß–°–ö:\n"
            for item in clan_results:
                message += f"   ‚Ä¢ {item['username']} - {item['reason']}\n"

        if staff_results:
            message += f"\nüö´ –ß–°–ö–ö:\n"
            for item in staff_results:
                message += f"   ‚Ä¢ {item['username']} - {item['reason']}\n"

        if not clan_results and not staff_results:
            message = f"‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É '{search_term}'"

        await update.message.reply_text(
            message,
            reply_markup=self.main_keyboard(user_id)
        )

        context.user_data.pop('awaiting_blacklist_search', None)
        return ConversationHandler.END

    async def view_blacklist(self, query, context, list_type, page=0):
        """–ü—Ä–æ—Å–º–æ—Ç—Ä —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞"""
        limit = 15
        blacklist = db.get_blacklist(list_type)

        if not blacklist:
            await query.edit_message_text(
                f"üìã {list_type} –ø—É—Å—Ç.",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å", callback_data=f"bl_add_{list_type}")],
                    [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_blacklist_menu")]
                ])
            )
            return

        total_items = len(blacklist)
        total_pages = (total_items + limit - 1) // limit
        start = page * limit
        end = start + limit
        current_page = blacklist[start:end]

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (–ù–ò–ö–ò –ë–ï–ó @)
        list_name = "‚ùå –ß–°–ö (–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª–∞–Ω–∞)" if list_type == BLACKLIST_CLAN else "üö´ –ß–°–ö–ö (–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥—ã)"
        message = f"{list_name}\n"
        message += f"üìä –í—Å–µ–≥–æ: {total_items} –∏–≥—Ä–æ–∫–æ–≤\n\n"

        for i, item in enumerate(current_page, start=start + 1):
            added_by = f" (–∞–¥–º–∏–Ω ID:{item['added_by']})" if item['added_by'] != 0 else ""
            message += f"{i}. {item['username']}{added_by}\n"
            if item['reason']:
                message += f"   ‚îî {item['reason']}\n"

        if total_pages > 1:
            message += f"\nüìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page + 1} –∏–∑ {total_pages}"

        await query.edit_message_text(
            message,
            reply_markup=self.blacklist_view_keyboard(list_type, page, total_pages)
        )

    async def show_blacklist_stats(self, query, context):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤"""
        clan_list = db.get_blacklist(BLACKLIST_CLAN)
        staff_list = db.get_blacklist(BLACKLIST_STAFF)

        message = "üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ß–ï–†–ù–´–• –°–ü–ò–°–ö–û–í\n\n"
        message += f"‚ùå –ß–°–ö: {len(clan_list)} –∏–≥—Ä–æ–∫–æ–≤\n"
        message += f"üö´ –ß–°–ö–ö: {len(staff_list)} –∏–≥—Ä–æ–∫–æ–≤\n\n"
        message += f"üìã –í—Å–µ–≥–æ –≤ –ß–°: {len(clan_list) + len(staff_list)} –∏–≥—Ä–æ–∫–æ–≤"

        await query.edit_message_text(
            message,
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_blacklist_menu")]
            ])
        )

    async def show_blacklist_menu_callback(self, query, context):
        """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é —á–µ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ —á–µ—Ä–µ–∑ callback"""
        await query.edit_message_text(
            "üìã –£–ü–†–ê–í–õ–ï–ù–ò–ï –ß–ï–†–ù–´–ú–ò –°–ü–ò–°–ö–ê–ú–ò\n\n"
            "–ß–°–ö (–ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª–∞–Ω–∞) - –∏–≥—Ä–æ–∫–æ–≤ –Ω–µ–ª—å–∑—è –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –∫–ª–∞–Ω\n"
            "–ß–°–ö–ö (–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥—ã –∫–ª–∞–Ω–∞) - –Ω–µ–ª—å–∑—è –ø—Ä–∏–Ω–∏–º–∞—Ç—å –Ω–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏",
            reply_markup=self.blacklist_menu_keyboard()
        )

    async def show_moderators_callback(self, query, context):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ callback"""
        if not MODERATOR_IDS:
            await query.edit_message_text(
                "üìã –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã.",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_back")]
                ])
            )
            return

        moderator_list = "üõ°Ô∏è –°–ü–ò–°–û–ö –ú–û–î–ï–†–ê–¢–û–†–û–í:\n\n"
        for i, mod_id in enumerate(MODERATOR_IDS, 1):
            mod_name = self.format_moderator_name(mod_id)
            moderator_list += f"{i}. {mod_name} (ID: {mod_id})\n"

        await query.edit_message_text(
            moderator_list,
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_back")]
            ])
        )

    async def show_applications(self, query, context: ContextTypes.DEFAULT_TYPE):
        try:
            applications = db.get_pending_applications()
            if not applications:
                await query.edit_message_text("‚úÖ –ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫.", reply_markup=self.admin_keyboard())
                return

            app = applications[0]

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—â–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–µ
            reviewer_info = ""
            if app['reviewed_by']:
                reviewer_name = self.format_admin_name(app['reviewed_by'])
                reviewer_info = f"\nüë§ –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç: {reviewer_name}"

            keyboard = [
                [
                    InlineKeyboardButton("üëÄ –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å", callback_data=f"app_review_{app['id']}"),
                ],
                [
                    InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω—è—Ç—å", callback_data=f"app_approve_{app['id']}"),
                    InlineKeyboardButton("‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"app_reject_{app['id']}")
                ],
                [InlineKeyboardButton("‚è≠Ô∏è –°–ª–µ–¥—É—é—â–∞—è", callback_data="admin_applications")],
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_back")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            full_name = f"{app['first_name'] or ''} {app['last_name'] or ''}".strip()
            username = f"@{app['username']}" if app['username'] else "–±–µ–∑ username"
            text = (f"üìù –ó–∞—è–≤–∫–∞ #{app['id']}\n"
                    f"üë§: {full_name} ({username})\n"
                    f"üÜî: {app['user_id']}\n"
                    f"üìÖ: {app['created_at']}"
                    f"{reviewer_info}\n\n"
                    f"üìÑ –ê–Ω–∫–µ—Ç–∞:\n{app['application_text']}")

            await query.edit_message_text(text, reply_markup=reply_markup)

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –∑–∞—è–≤–æ–∫: {e}")
            await query.edit_message_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞—è–≤–æ–∫.",
                reply_markup=self.admin_keyboard()
            )

    async def show_questions(self, query, context: ContextTypes.DEFAULT_TYPE):
        try:
            questions = db.get_unanswered_questions()
            if not questions:
                await query.edit_message_text("‚úÖ –ù–µ—Ç –Ω–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.", reply_markup=self.admin_keyboard())
                return

            question = questions[0]

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—â–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–µ
            reviewer_info = ""
            if question['reviewed_by']:
                reviewer_name = self.format_admin_name(question['reviewed_by'])
                reviewer_info = f"\nüë§ –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç: {reviewer_name}"

            keyboard = [
                [
                    InlineKeyboardButton("üëÄ –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å", callback_data=f"question_review_{question['id']}"),
                ],
                [
                    InlineKeyboardButton("‚úÖ –û—Ç–≤–µ—Ç–∏—Ç—å", callback_data=f"question_answer_{question['id']}"),
                    InlineKeyboardButton("‚ùå –£–¥–∞–ª–∏—Ç—å", callback_data=f"question_delete_{question['id']}")
                ],
                [InlineKeyboardButton("‚è≠Ô∏è –°–ª–µ–¥—É—é—â–∏–π", callback_data="admin_questions")],
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin_back")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            full_name = f"{question['first_name'] or ''} {question['last_name'] or ''}".strip()
            username = f"@{question['username']}" if question['username'] else "–±–µ–∑ username"
            text = (f"‚ùì –í–æ–ø—Ä–æ—Å #{question['id']}\n"
                    f"üë§: {full_name} ({username})\n"
                    f"üÜî: {question['user_id']}\n"
                    f"üìÖ: {question['created_at']}"
                    f"{reviewer_info}\n\n"
                    f"üìÑ –í–æ–ø—Ä–æ—Å:\n{question['question_text']}")

            await query.edit_message_text(text, reply_markup=reply_markup)

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –≤–æ–ø—Ä–æ—Å–æ–≤: {e}")
            await query.edit_message_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–æ–ø—Ä–æ—Å–æ–≤.",
                reply_markup=self.admin_keyboard()
            )

    async def show_stats(self, query, context: ContextTypes.DEFAULT_TYPE):
        stats = db.get_stats()
        text = (f"üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–û–¢–ê:\n\n"
                f"üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['total_users']}\n"
                f"üìù –ó–∞—è–≤–æ–∫: {stats['total_applications']}\n"
                f"‚ùì –í–æ–ø—Ä–æ—Å–æ–≤: {stats['total_questions']}\n"
                f"üí¨ –û—Ç–∑—ã–≤–æ–≤: {stats['total_feedback']}\n"
                f"‚è≥ –ù–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫: {stats['pending_applications']}\n"
                f"‚è≥ –ù–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤: {stats['unanswered_questions']}\n"
                f"üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö: {stats['banned_users']}\n"
                f"üÜï –ù–æ–≤—ã—Ö —Å–µ–≥–æ–¥–Ω—è: {stats['new_users_today']}\n"
                f"üìà –ù–æ–≤—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é: {stats['new_users_week']}\n"
                f"‚≠ê –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: {stats['avg_feedback_rating']}/5\n\n"
                f"üìã –ß–ï–†–ù–´–ï –°–ü–ò–°–ö–ò:\n"
                f"‚ùå –ß–°–ö: {stats['blacklist_clan_count']} –∏–≥—Ä–æ–∫–æ–≤\n"
                f"üö´ –ß–°–ö–ö: {stats['blacklist_staff_count']} –∏–≥—Ä–æ–∫–æ–≤")

        await query.edit_message_text(text, reply_markup=self.admin_keyboard())

    async def show_banned_users_callback(self, query, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ callback"""
        banned_users = db.get_banned_users()
        if not banned_users:
            await query.edit_message_text("‚úÖ –ù–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.", reply_markup=self.admin_keyboard())
            return

        banned_list = "üö´ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò:\n\n"
        for banned in banned_users:
            banned_by = f"@{banned['banned_by_username']}" if banned[
                'banned_by_username'] else f"ID: {banned['banned_by']}"
            banned_list += (
                f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{banned['username']} (ID: {banned['user_id']})\n"
                f"üìù –ü—Ä–∏—á–∏–Ω–∞: {banned['reason']}\n"
                f"üëÆ‚Äç‚ôÇÔ∏è –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª: {banned_by}\n"
                f"üìÖ –î–∞—Ç–∞: {banned['banned_at']}\n"
                f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
            )

        await query.edit_message_text(banned_list, reply_markup=self.admin_keyboard())

    async def show_settings(self, query, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
        await query.edit_message_text(
            "‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ë–û–¢–ê\n\n"
            "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –±–æ—Ç–∞:",
            reply_markup=self.settings_keyboard()
        )

    async def show_feedback_callback(self, query, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Ñ–∏–¥–±–µ–∫ —á–µ—Ä–µ–∑ callback"""
        feedback_list = db.get_feedback(limit=10)

        if not feedback_list:
            await query.edit_message_text("üí¨ –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.", reply_markup=self.admin_keyboard())
            return

        message = "üí¨ –ü–û–°–õ–ï–î–ù–ò–ï –û–¢–ó–´–í–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô\n\n"

        for i, feedback in enumerate(feedback_list, 1):
            username = f"@{feedback['username']}" if feedback['username'] else "–±–µ–∑ username"
            full_name = f"{feedback['first_name'] or ''} {feedback['last_name'] or ''}".strip()
            rating = "‚≠ê" * feedback['rating'] if feedback['rating'] else "üìù –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç"
            date = feedback['created_at'].split()[0]

            message += f"{i}. {full_name} ({username})\n"
            message += f"   {rating}\n"
            message += f"   üí¨ {feedback['feedback_text'][:100]}{'...' if len(feedback['feedback_text']) > 100 else ''}\n"
            message += f"   üìÖ {date}\n\n"

        await query.edit_message_text(
            message,
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üîô –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_back")]
            ])
        )

    async def show_logs_callback(self, query, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ —á–µ—Ä–µ–∑ callback"""
        logs = db.get_action_logs(limit=15)

        if not logs:
            await query.edit_message_text("üìù –õ–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.", reply_markup=self.admin_keyboard())
            return

        message = "üìù –ü–û–°–õ–ï–î–ù–ò–ï –î–ï–ô–°–¢–í–ò–Ø\n\n"

        for log in logs:
            username = f"@{log['username']}" if log['username'] else f"ID:{log['user_id']}"
            time = log['created_at'].split()[1][:5]  # —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è
            message += f"üïí {time} | {username} | {log['action']}"
            if log['details']:
                message += f" | {log['details'][:30]}..."
            message += "\n"

        await query.edit_message_text(
            message,
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üîô –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_back")]
            ])
        )

    async def export_data_callback(self, query, context: ContextTypes.DEFAULT_TYPE):
        """–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ callback"""
        await self.export_data(query, context)

    async def cleanup_data_callback(self, query, context: ContextTypes.DEFAULT_TYPE):
        """–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ callback"""
        await query.edit_message_text(
            "üßπ –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30):\n\n"
            "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å' –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞.",
            reply_markup=self.cancel_keyboard()
        )
        context.user_data['cleaning_data'] = True

    async def backup_database_callback(self, query, context: ContextTypes.DEFAULT_TYPE):
        """Backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ callback"""
        await self.backup_database(query, context)

    async def recent_users_callback(self, query, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ callback"""
        users = db.get_recent_users(days=7)

        if not users:
            await query.edit_message_text("‚ùå –ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.",
                                          reply_markup=self.admin_keyboard())
            return

        message = "üÜï –ù–û–í–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)\n\n"

        for i, user in enumerate(users, start=1):
            username = f"@{user['username']}" if user['username'] else "–±–µ–∑ username"
            full_name = f"{user['first_name'] or ''} {user['last_name'] or ''}".strip()
            created_date = user['created_at'].split()[0] if user['created_at'] else "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

            message += f"{i}. {full_name} ({username})\n"
            message += f"   üÜî: {user['user_id']}\n"
            message += f"   üìÖ: {created_date}\n\n"

        message += f"üìä –í—Å–µ–≥–æ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(users)}"

        await query.edit_message_text(
            message,
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üîô –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_back")]
            ])
        )

    async def handle_application_action(self, query, data, context: ContextTypes.DEFAULT_TYPE):
        user_id = query.from_user.id
        action, app_id = data.split("_")[1], int(data.split("_")[2])
        application = db.get_application(app_id)

        if action == "review":
            # –ù–∞—á–∞—Ç—å —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
            db.start_review_application(app_id, user_id)
            db.log_action(user_id, "review_application", f"–ó–∞—è–≤–∫–∞ #{app_id}")

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            admin_name = self.format_admin_name(user_id)

            # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try:
                await self.application.bot.send_message(
                    application['user_id'],
                    f"üîç –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é –≤–∑—è—Ç–∞ –≤ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {admin_name}. –û–∂–∏–¥–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è!"
                )
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {e}")

            await query.edit_message_text(
                f"üëÄ –í—ã –Ω–∞—á–∞–ª–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ #{app_id}",
                reply_markup=self.admin_keyboard()
            )

        elif action == "approve":
            db.update_application_status(app_id, "approved", user_id)
            db.log_action(user_id, "approve_application", f"–ó–∞—è–≤–∫–∞ #{app_id}")

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            admin_name = self.format_admin_name(user_id)

            try:
                await self.application.bot.send_message(
                    application['user_id'],
                    f"üéâ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é –æ–¥–æ–±—Ä–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {admin_name}!\n\n"
                    f"üìù –°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç: {CHAT_LINK}\n\n"
                    f"–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–µ–º—É —á–∞—Ç—É –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π!"
                )
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {e}")

            await query.edit_message_text(f"‚úÖ –ó–∞—è–≤–∫–∞ #{app_id} –æ–¥–æ–±—Ä–µ–Ω–∞.", reply_markup=self.admin_keyboard())

        elif action == "reject":
            db.update_application_status(app_id, "rejected", user_id)
            db.log_action(user_id, "reject_application", f"–ó–∞—è–≤–∫–∞ #{app_id}")

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            admin_name = self.format_admin_name(user_id)

            try:
                await self.application.bot.send_message(
                    application['user_id'],
                    f"‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {admin_name}."
                )
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {e}")

            await query.edit_message_text(f"‚ùå –ó–∞—è–≤–∫–∞ #{app_id} –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.", reply_markup=self.admin_keyboard())

    async def handle_question_action(self, query, data, context: ContextTypes.DEFAULT_TYPE):
        user_id = query.from_user.id
        action, question_id = data.split("_")[1], int(data.split("_")[2])
        question = db.get_question(question_id)

        if action == "review":
            # –ù–∞—á–∞—Ç—å —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞
            db.start_review_question(question_id, user_id)
            db.log_action(user_id, "review_question", f"–í–æ–ø—Ä–æ—Å #{question_id}")

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            admin_name = self.format_admin_name(user_id)

            # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try:
                await self.application.bot.send_message(
                    question['user_id'],
                    f"üîç –í–∞—à –≤–æ–ø—Ä–æ—Å –≤–∑—è—Ç –≤ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {admin_name}. –°–∫–æ—Ä–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –æ—Ç–≤–µ—Ç!"
                )
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {e}")

            await query.edit_message_text(
                f"üëÄ –í—ã –Ω–∞—á–∞–ª–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ #{question_id}",
                reply_markup=self.admin_keyboard()
            )

        elif action == "answer":
            context.user_data['answering_question'] = question_id
            await query.edit_message_text(
                f"üí¨ –í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ—Ç @{question['username']}:"
            )
        elif action == "delete":
            db.update_question_status(question_id, "deleted", user_id)
            db.log_action(user_id, "delete_question", f"–í–æ–ø—Ä–æ—Å #{question_id}")

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            admin_name = self.format_admin_name(user_id)

            await query.edit_message_text(f"‚úÖ –í–æ–ø—Ä–æ—Å #{question_id} —É–¥–∞–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {admin_name}.",
                                          reply_markup=self.admin_keyboard())

    async def notify_admins_about_review(self, reviewer_id, item_type, item_id, item_info):
        """–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –æ –Ω–∞—á–∞–ª–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è –∑–∞—è–≤–∫–∏/–≤–æ–ø—Ä–æ—Å–∞"""
        reviewer_name = self.format_admin_name(reviewer_id)

        if item_type == "application":
            message = (
                f"üîç –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {reviewer_name} –Ω–∞—á–∞–ª —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ #{item_id}\n"
                f"üë§ –ö–∞–Ω–¥–∏–¥–∞—Ç: @{item_info['username']} (ID: {item_info['user_id']})\n"
                f"üìÖ –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è: {item_info['created_at']}"
            )
        elif item_type == "question":
            message = (
                f"üîç –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {reviewer_name} –Ω–∞—á–∞–ª —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ #{item_id}\n"
                f"üë§ –ê–≤—Ç–æ—Ä: @{item_info['username']} (ID: {item_info['user_id']})\n"
                f"üìÖ –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è: {item_info['created_at']}"
            )
        else:
            return

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤ –∫—Ä–æ–º–µ —Ç–æ–≥–æ, –∫—Ç–æ –Ω–∞—á–∞–ª —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ
        for admin_id in ADMIN_IDS:
            if admin_id != reviewer_id:
                try:
                    await self.application.bot.send_message(admin_id, message)
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞ {admin_id}: {e}")

    def run(self):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
        if BOT_TOKEN == "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê_–ó–î–ï–°–¨":
            print("‚ùå –û–®–ò–ë–ö–ê: –ó–∞–º–µ–Ω–∏—Ç–µ BOT_TOKEN –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞!")
            print("1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather –≤ Telegram")
            print("2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω")
            print("3. –ó–∞–º–µ–Ω–∏—Ç–µ —Å—Ç—Ä–æ–∫—É BOT_TOKEN –≤ –∫–æ–¥–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω")
            return

        self.application = Application.builder().token(BOT_TOKEN).build()
        self.setup_handlers()

        print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
        print("ü§ñ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
        print("üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã:", ADMIN_IDS)
        print("üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã:", MODERATOR_IDS)
        print("üîß –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–≤:", ADMIN_USERNAME_MAP)
        print("üîß –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤:", MODERATOR_USERNAME_MAP)
        print("üí¨ –°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç:", CHAT_LINK)
        print("üìã –õ–æ–≥-—á–∞—Ç ID:", LOG_CHAT_ID)
        print("üìã –õ–æ–≥-—Ç–µ–º–∞ ID:", LOG_TOPIC_ID if LOG_TOPIC_ID else "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (–æ–±—â–∏–π —á–∞—Ç)")
        print("üìã –ß–µ—Ä–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:")
        print(f"   ‚ùå –ß–°–ö: {len(INITIAL_BLACKLIST_CLAN)} –∏–≥—Ä–æ–∫–æ–≤")
        print(f"   üö´ –ß–°–ö–ö: {len(INITIAL_BLACKLIST_STAFF)} –∏–≥—Ä–æ–∫–æ–≤")
        print("üõ†Ô∏è –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:")
        print("   /start - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞")
        print("   /menu - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
        print("   /admin - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
        print("   /moderator - –ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞")
        print("   /blacklist - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ß–°")
        print("   /status - –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞")
        print("   /help - –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º")
        print("‚ö†Ô∏è –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö (–õ–°)")

        self.application.run_polling()


if __name__ == '__main__':
    bot = MinecraftBot()
    bot.run()


